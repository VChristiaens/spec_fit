<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>special tutorial &mdash; special  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Contributions" href="../about.html" />
    <link rel="prev" title="TL;DR setup guide" href="../trimmed_readme.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html">
            <img src="../_static/Special_logo.jpeg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../features.html">What makes it <cite>special</cite>?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trimmed_readme.html">TL;DR setup guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trimmed_readme.html#installation-and-dependencies">Installation and dependencies</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorial</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#"><em>special</em> tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Table-of-contents">Table of contents</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#1.-Loading-the-data">1. Loading the data</a></li>
<li class="toctree-l1"><a class="reference internal" href="#2.-Spectral-correlation-matrix">2. Spectral correlation matrix</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#2.1-Estimating-the-spectral-correlation-between-IFS-channels">2.1 Estimating the spectral correlation between IFS channels</a></li>
<li class="toctree-l2"><a class="reference internal" href="#2.2-Concatenating-spectral-correlation-matrices">2.2 Concatenating spectral correlation matrices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#3.-Preliminary-spectral-analysis">3. Preliminary spectral analysis</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#3.1-Dereddening">3.1 Dereddening</a></li>
<li class="toctree-l2"><a class="reference internal" href="#3.2-Spectral-indices">3.2 Spectral indices</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#4.-MCMC-sampler-examples">4. MCMC sampler examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#4.1.-Parameters">4.1. Parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#4.2.-Blackbody-model">4.2. Blackbody model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#4.3.-BT-SETTL-model">4.3. BT-SETTL model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#4.4.-BT-SETTL-+-BB-model">4.4. BT-SETTL + BB model</a></li>
<li class="toctree-l2"><a class="reference internal" href="#4.5.-BT-SETTL-model-+-BrG-line-model">4.5. BT-SETTL model + BrG line model</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#5.-Comparison-of-results">5. Comparison of results</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#5.1.-Akaike-Information-Criterion">5.1. Akaike Information Criterion</a></li>
<li class="toctree-l2"><a class="reference internal" href="#5.2.-Best-fit-models">5.2. Best-fit models</a></li>
<li class="toctree-l2"><a class="reference internal" href="#5.3.-Models-from-the-posterior-distribution">5.3. Models from the posterior distribution</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#6.-Nested-sampler-examples">6. Nested sampler examples</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#6.1.-Single-ellipsoid-method">6.1. Single ellipsoid method</a></li>
<li class="toctree-l2"><a class="reference internal" href="#6.2.-Multi-ellipsoid-method">6.2. Multi-ellipsoid method</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#7.-Best-fit-template-spectrum">7. Best-fit template spectrum</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">About</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../about.html">Contributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html#questions-and-suggestions">Questions and suggestions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../about.html#acknowledgements">Acknowledgements</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Package content</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../special.html">special.chi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special.html#module-special.config">special.config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special.html#module-special.fits">special.fits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special.html#module-special.mcmc_sampling">special.mcmc_sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special.html#module-special.model_resampling">special.model_resampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special.html#module-special.nested_sampling">special.nested_sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special.html#module-special.spec_corr">special.spec_corr</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special.html#module-special.spec_indices">special.spec_indices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special.html#module-special.template_fit">special.template_fit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special.html#module-special.utils_mcmc">special.utils_mcmc</a></li>
<li class="toctree-l1"><a class="reference internal" href="../special.html#module-special.utils_spec">special.utils_spec</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">special</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li><em>special</em> tutorial</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/VChristiaens/special/blob/main/docs/tutorials/walkthrough.ipynb" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="special-tutorial">
<h1><em>special</em> tutorial<a class="headerlink" href="#special-tutorial" title="Permalink to this headline"></a></h1>
<p>Written by: <em>Valentin Christiaens</em>.</p>
<p>Last update: <em>2022/02/17</em></p>
<div class="section" id="Table-of-contents">
<h2>Table of contents<a class="headerlink" href="#Table-of-contents" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p><a class="reference external" href="#1.-Loading-the-data">1. Loading the data</a></p></li>
<li><p><a class="reference external" href="#2.-Spectral-correlation-matrix">2. Spectral correlation matrix</a></p>
<ul>
<li><p><a class="reference external" href="#2.1-Estimating-the-spectral-correlation-between-IFS-channels">2.1 Estimating the spectral correlation between IFS channels</a></p></li>
<li><p><a class="reference external" href="#2.2-Concatenating-spectral-correlation-matrices">2.2 Concatenating spectral correlation matrices</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#3.-Preliminary-spectral-analysis">3. Preliminary spectral analysis</a></p>
<ul>
<li><p><a class="reference external" href="#3.1-Dereddening">3.1 Dereddening</a></p></li>
<li><p><a class="reference external" href="#3.2-Spectral-indices">3.2 Spectral indices</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#4.-MCMC-sampler-examples">4. MCMC sampler examples</a></p>
<ul>
<li><p><a class="reference external" href="#4.1.-Parameters">4.1. Parameters</a></p></li>
<li><p><a class="reference external" href="#4.2.-Blackbody-model">4.2. Blackbody model</a></p></li>
<li><p><a class="reference external" href="#4.3.-BT-SETTL-model">4.3. BT-SETTL model</a></p></li>
<li><p><a class="reference external" href="#4.4.-BT-SETTL-+-BB-model">4.4. BT-SETTL + BB model</a></p></li>
<li><p><a class="reference external" href="#4.5.-BT-SETTL-+-BrG-line-model">4.5. BT-SETTL + BrG line model</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#5.-Comparison-of-results">5. Comparison of results</a></p>
<ul>
<li><p><a class="reference external" href="#5.1.-Akaike-Information-Criterion">5.1. Akaike Information Criterion</a></p></li>
<li><p><a class="reference external" href="#5.2.-Best-fit-models">5.2. Best-fit models</a></p></li>
<li><p><a class="reference external" href="#5.3.-Models-from-the-posterior-distribution">5.3. Models from the posterior distribution</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#6.-Nested-sampler-examples">6. Nested sampler examples</a></p>
<ul>
<li><p><a class="reference external" href="#6.1.-Single-ellipsoid-method">6.1. Single ellipsoid method</a></p></li>
<li><p><a class="reference external" href="#6.2.-Multi-ellipsoid-method">6.2. Multi-ellipsoid method</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="#7.-Best-fit-template-spectrum">7. Best-fit template spectrum</a></p></li>
</ul>
<hr class="docutils" />
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">special</span>
<span class="n">special</span><span class="o">.</span><span class="n">__version__</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;0.0.3&#39;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="1.-Loading-the-data">
<h1>1. Loading the data<a class="headerlink" href="#1.-Loading-the-data" title="Permalink to this headline"></a></h1>
<p>In the ‘dataset’ folder of the <code class="docutils literal notranslate"><span class="pre">specfit_extras</span></code> repository you can find:</p>
<ul class="simple">
<li><p>a post-processed Integral Field Spectrograph (IFS) datacube (<code class="docutils literal notranslate"><span class="pre">CrA-9_2019_IFS_pca_annulus.fits</span></code>);</p></li>
<li><p>the measured spectrum of (sub)stellar companion CrA-9 b/B (<code class="docutils literal notranslate"><span class="pre">CrA-9b_spectrum.fits</span></code>).</p></li>
</ul>
<p>In the post-processed IFS cube, the emission from the central star has been modeled and subtracted using the ADI strategy in each spectral channel. The post-processing was performed using principal component analysis (PCA) applied in a single annulus. The annulus was chosen to encompass the faint (sub)stellar companion CrA-9b/B, which can be seen towards the left of the images.</p>
<p>Let’s first inspect the IFS cube using the <code class="docutils literal notranslate"><span class="pre">info_fits</span></code> utility implemented in the <code class="docutils literal notranslate"><span class="pre">fits</span></code> module:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.fits</span> <span class="kn">import</span> <span class="n">info_fits</span>
<span class="n">info_fits</span><span class="p">(</span><span class="s1">&#39;../datasets/CrA-9_2019_IFS_pca_annulus.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Filename: ../datasets/CrA-9_2019_IFS_pca_annulus.fits
No.    Name      Ver    Type      Cards   Dimensions   Format
  0  PRIMARY       1 PrimaryHDU       7   (291, 291, 39)   float64
</pre></div></div>
</div>
<p>The fits file contains an IFS datacube of 39 images with wavelengths spanning 0.95 to 1.68 <span class="math notranslate nohighlight">\(\mu\)</span>m. Each image is 291x291 px across. Let’s now open it and check a few spectral channels.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.fits</span> <span class="kn">import</span> <span class="n">open_fits</span>
<span class="n">ifs_cube</span> <span class="o">=</span> <span class="n">open_fits</span><span class="p">(</span><span class="s1">&#39;../datasets/CrA-9_2019_IFS_pca_annulus.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Fits HDU-0 data successfully loaded. Data shape: (39, 291, 291)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.config</span> <span class="kn">import</span> <span class="n">figsize</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ifs_cube</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ifs_cube</span><span class="p">[</span><span class="mi">19</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ifs_cube</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.image.AxesImage at 0x7f9e10889700&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_11_1.png" src="../_images/tutorials_walkthrough_11_1.png" />
</div>
</div>
<p>A point source can be seen towards the left of the image. This is CrA-9 b/B, a faint companion to the pre-main sequence star CrA-9, whose nature is still debated (Christiaens et al. 2021). In addition to this IFS datacube obtained with VLT instrument SPHERE/IFS, three additional detections of the companion were obtained with VLT imagers SPHERE/IRDIS at 2.11 <span class="math notranslate nohighlight">\(\mu\)</span>m and 2.25<span class="math notranslate nohighlight">\(\mu\)</span>m, and NACO at 3.8 <span class="math notranslate nohighlight">\(\mu\)</span>m. The full measured spectrum contains thus 42 points:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">info_fits</span><span class="p">(</span><span class="s1">&#39;../datasets/CrA-9b_spectrum.fits&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Filename: ../datasets/CrA-9b_spectrum.fits
No.    Name      Ver    Type      Cards   Dimensions   Format
  0  PRIMARY       1 PrimaryHDU       6   (42, 4)   float32
</pre></div></div>
</div>
<p>The 4 dimensions correspond to:</p>
<ul class="simple">
<li><p>the wavelength of each measurement (in <span class="math notranslate nohighlight">\(\mu\)</span>m);</p></li>
<li><p>the channel width (or FWHM of the broad band filter used in the case or IRDIS and NACO);</p></li>
<li><p>the flux of the companion;</p></li>
<li><p>the error on the flux.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spectrum_b</span> <span class="o">=</span> <span class="n">open_fits</span><span class="p">(</span><span class="s1">&#39;../datasets/CrA-9b_spectrum.fits&#39;</span><span class="p">)</span>

<span class="n">lbda</span> <span class="o">=</span> <span class="n">spectrum_b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">dlbda</span> <span class="o">=</span> <span class="n">spectrum_b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">spec</span> <span class="o">=</span> <span class="n">spectrum_b</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">spec_err</span> <span class="o">=</span> <span class="n">spectrum_b</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Fits HDU-0 data successfully loaded. Data shape: (4, 42)
</pre></div></div>
</div>
<p>The flux units follow the SI convention (W m<span class="math notranslate nohighlight">\(^{-2}\)</span>). Let’s set it for later. Note that <code class="docutils literal notranslate"><span class="pre">specfit</span></code> can also handle ‘cgs’ and ‘jy’. The relevant conversions will be made internally if units are provided for observed and model spectra. If not specified, <code class="docutils literal notranslate"><span class="pre">specfit</span></code> assumes SI units.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">units_obs</span> <span class="o">=</span> <span class="s1">&#39;si&#39;</span>
</pre></div>
</div>
</div>
<p>Let’s visualize the measured spectrum in <span class="math notranslate nohighlight">\(\lambda F_{\lambda}\)</span> units:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">lbda</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">lbda</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">spec</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">lbda</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">spec_err</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">dlbda</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;bo&#39;</span><span class="p">,</span>
             <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;SPHERE/IFS (YJH)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">lbda</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">lbda</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">spec</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">lbda</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">spec_err</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dlbda</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;ms&#39;</span><span class="p">,</span>
             <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;SPHERE/IRDIS (K12)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">lbda</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">lbda</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">spec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">lbda</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">spec_err</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dlbda</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;rs&#39;</span><span class="p">,</span>
             <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;NACO (L&#39;)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Flux (W/m$^2$)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f9de006d6d0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_19_1.png" src="../_images/tutorials_walkthrough_19_1.png" />
</div>
</div>
<p><a class="reference external" href="#Table-of-contents">Go to the top</a></p>
</div>
<div class="section" id="2.-Spectral-correlation-matrix">
<h1>2. Spectral correlation matrix<a class="headerlink" href="#2.-Spectral-correlation-matrix" title="Permalink to this headline"></a></h1>
<div class="section" id="2.1-Estimating-the-spectral-correlation-between-IFS-channels">
<h2>2.1 Estimating the spectral correlation between IFS channels<a class="headerlink" href="#2.1-Estimating-the-spectral-correlation-between-IFS-channels" title="Permalink to this headline"></a></h2>
<p>Before fitting different models to the spectrum, let’s first estimate the spectral correlation between the IFS channels. By design of the IFS, the flux at a given wavelength leaks on/overlaps with neighbouring channels. These can therefore not be considered as independent measurements. The spectral correlation matrix has therefore to be considered when fitting a given IFS spectrum. Not taking it into account can indeed lead to significant biases, and in particular to erroneous results in terms
of best-fit model parameters (see e.g. Greco &amp; Brant 2017).</p>
<p>Estimating the spectral correlation can be done easily in <code class="docutils literal notranslate"><span class="pre">specfit</span></code> using the <code class="docutils literal notranslate"><span class="pre">spectral_correlation</span></code> routine, which follows the method recommended in Greco &amp; Brandt (2017). For that let’s first determine the location of the companion in the IFS images, by zooming on the median image of the cube:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_i</span> <span class="o">=</span> <span class="mi">35</span>
<span class="n">y_i</span> <span class="o">=</span> <span class="mi">130</span>
<span class="n">sz</span> <span class="o">=</span> <span class="mi">31</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">ifs_cube</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">y_i</span><span class="p">:</span><span class="n">y_i</span><span class="o">+</span><span class="n">sz</span><span class="p">,</span><span class="n">x_i</span><span class="p">:</span><span class="n">x_i</span><span class="o">+</span><span class="n">sz</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_25_0.png" src="../_images/tutorials_walkthrough_25_0.png" />
</div>
</div>
<p>Based on the above inset, we can set the approximate coordinates of the companion, and infer its radial separation:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pl_xy</span> <span class="o">=</span> <span class="p">((</span><span class="n">x_i</span><span class="o">+</span><span class="mi">17</span><span class="p">,</span><span class="n">y_i</span><span class="o">+</span><span class="mi">11</span><span class="p">),)</span> <span class="c1"># set pl_xy as a tuple of 2-element tuples - each tuple corresponds to a different companion</span>

<span class="n">cy</span> <span class="o">=</span> <span class="p">(</span><span class="n">ifs_cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span>
<span class="n">cx</span> <span class="o">=</span> <span class="p">(</span><span class="n">ifs_cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span>
<span class="n">r0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">pl_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">cx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">pl_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">cy</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">r0</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
93.08598175880189
</pre></div></div>
</div>
<p>The spectral correlation depends on the radial separation to the central star. The algorithm implemented in <code class="docutils literal notranslate"><span class="pre">specfit</span></code> can therefore compute it in concentric annuli between given inner and outer radii (by default spanning the whole field). Here since we are only interested in the spectral correlation at the radial separation of the companion, let’s set the annular width, inner and outer radii such that they only encompass the companion radial separation:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">awidth</span><span class="o">=</span><span class="mi">2</span>
<span class="n">r_in</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r0</span><span class="o">-</span><span class="n">awidth</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
<span class="n">r_out</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">r0</span><span class="o">+</span><span class="n">awidth</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Furthermore, we mask the area around the companion to not bias the spectral correlation estimate with companion flux. We set the mask radius to be 4 times the FWHM, with a FWHM set to 4px:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mask_r</span><span class="o">=</span><span class="mi">4</span>
<span class="n">fwhm</span><span class="o">=</span><span class="mi">4</span>
</pre></div>
</div>
</div>
<p>Now, we can estimate the spectral correlation at the radial separation of CrA-9b/B:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.spec_corr</span> <span class="kn">import</span> <span class="n">spectral_correlation</span>
<span class="n">sp_corr</span> <span class="o">=</span> <span class="n">spectral_correlation</span><span class="p">(</span><span class="n">ifs_cube</span><span class="p">,</span> <span class="n">awidth</span><span class="o">=</span><span class="n">awidth</span><span class="p">,</span> <span class="n">r_in</span><span class="o">=</span><span class="n">r_in</span><span class="p">,</span> <span class="n">r_out</span><span class="o">=</span><span class="n">r_out</span><span class="p">,</span> <span class="n">pl_xy</span><span class="o">=</span><span class="n">pl_xy</span><span class="p">,</span>
                               <span class="n">mask_r</span><span class="o">=</span><span class="n">mask_r</span><span class="p">,</span> <span class="n">fwhm</span><span class="o">=</span><span class="n">fwhm</span><span class="p">)</span>
<span class="n">sp_corr</span> <span class="o">=</span> <span class="n">sp_corr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>Let’s visualize it:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">sp_corr</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_35_0.png" src="../_images/tutorials_walkthrough_35_0.png" />
</div>
</div>
<p>We see that, as expected, each spectral channel is most correlated to itself, and at most to its 2 closest neighbouring channels. Depending on the number of principal components (npc) subtracted during the PCA, a stronger (low npc) or lower (high npc) residual correlation will be seen between adjacent channels.</p>
</div>
<div class="section" id="2.2-Concatenating-spectral-correlation-matrices">
<h2>2.2 Concatenating spectral correlation matrices<a class="headerlink" href="#2.2-Concatenating-spectral-correlation-matrices" title="Permalink to this headline"></a></h2>
<p>Since our full spectrum of CrA-9b/B also contains photometric points measured by SPHERE/IRDIS (2) and NACO (1), we need to pad the IFS spectral correlation matrix with 3 additional rows and columns of zeroes + ones on the diagonal, in order to get the final spectral correlation matrix.</p>
<p>This can easily be done with the <code class="docutils literal notranslate"><span class="pre">combine_spec_corrs</span></code> routine:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.utils_spec</span> <span class="kn">import</span> <span class="n">combine_spec_corrs</span>

<span class="n">n_ird</span><span class="o">=</span><span class="mi">2</span>
<span class="n">n_naco</span><span class="o">=</span><span class="mi">1</span>
<span class="n">arr_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">sp_corr</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">n_ird</span><span class="o">+</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">n_naco</span>

<span class="n">final_sp_corr</span> <span class="o">=</span> <span class="n">combine_spec_corrs</span><span class="p">(</span><span class="n">arr_list</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let’s visualize the final matrix:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">final_sp_corr</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_41_0.png" src="../_images/tutorials_walkthrough_41_0.png" />
</div>
</div>
<p>Uncomment the lines in the following box if you wish to save the final spectral correlation matrix in fits format.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#from special.fits import write_fits</span>
<span class="c1">#write_fits(&quot;../datasets/CrA-9_sp_corr_matrix.fits&quot;, final_sp_corr)</span>
</pre></div>
</div>
</div>
<p><a class="reference external" href="#Table-of-contents">Go to the top</a></p>
</div>
</div>
<div class="section" id="3.-Preliminary-spectral-analysis">
<h1>3. Preliminary spectral analysis<a class="headerlink" href="#3.-Preliminary-spectral-analysis" title="Permalink to this headline"></a></h1>
<p>A number of utilities are implemented in the <code class="docutils literal notranslate"><span class="pre">utils_spec</span></code> module, which allow for a preliminary qualitative analysis of the spectrum of the companion. However, to avoid biased conclusions due to extinction in this preliminary analysis, let’s first deredden the observed spectrum using the value quoted in the literature for CrA-9 (<span class="math notranslate nohighlight">\(A_V = 1.6\)</span> mag; Dunham et a. 2015).</p>
<div class="section" id="3.1-Dereddening">
<h2>3.1 Dereddening<a class="headerlink" href="#3.1-Dereddening" title="Permalink to this headline"></a></h2>
<p>Provided a given <span class="math notranslate nohighlight">\(A_V\)</span> extinction value, the <code class="docutils literal notranslate"><span class="pre">extinction</span></code> routine can estimate the corresponding extinction factor at different wavelengths following the Cardelli et al. (1989) law, and for a desired <span class="math notranslate nohighlight">\(R_V\)</span> value. Let’s consider the standard ISM value of <span class="math notranslate nohighlight">\(R_V = 3.1\)</span> mag (default if not provided).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.utils_spec</span> <span class="kn">import</span> <span class="n">extinction</span>
<span class="n">AV_est</span> <span class="o">=</span> <span class="mf">1.6</span> <span class="c1">#mag</span>
<span class="n">A_lambda</span> <span class="o">=</span> <span class="n">extinction</span><span class="p">(</span><span class="n">lbda</span><span class="p">,</span> <span class="n">AV_est</span><span class="p">,</span> <span class="n">RV</span><span class="o">=</span><span class="mf">3.1</span><span class="p">)</span>
<span class="n">extinc_fac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="o">-</span><span class="n">A_lambda</span><span class="o">/</span><span class="mf">2.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let’s plot the extinction factor as a function of wavelength:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lbda</span><span class="p">,</span> <span class="n">extinc_fac</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Extinction factor&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0, 0.5, &#39;Extinction factor&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_51_1.png" src="../_images/tutorials_walkthrough_51_1.png" />
</div>
</div>
<p>We see that as expected the effect of extinction is stronger at shorter NIR wavelengths: at 1.0 <span class="math notranslate nohighlight">\(\mu\)</span>m roughly only half of the flux is transmitted, while at <span class="math notranslate nohighlight">\(L'\)</span> band (3.8 <span class="math notranslate nohighlight">\(\mu\)</span>m) <span class="math notranslate nohighlight">\(\sim\)</span> 93% of the flux is transmitted.</p>
<p>Let’s now deredden the spectrum accordingly and plot it:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spec_dered</span> <span class="o">=</span> <span class="n">spec</span><span class="o">/</span><span class="n">extinc_fac</span>
<span class="n">spec_dered_err</span> <span class="o">=</span> <span class="n">spec_err</span><span class="o">/</span><span class="n">extinc_fac</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lbda</span><span class="p">,</span> <span class="n">lbda</span><span class="o">*</span><span class="n">spec</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Observed spectrum&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lbda</span><span class="p">,</span> <span class="n">lbda</span><span class="o">*</span><span class="n">spec_dered</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Dereddened spectrum&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Flux (W/m$^2$)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f9e2062c9d0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_54_1.png" src="../_images/tutorials_walkthrough_54_1.png" />
</div>
</div>
</div>
<div class="section" id="3.2-Spectral-indices">
<h2>3.2 Spectral indices<a class="headerlink" href="#3.2-Spectral-indices" title="Permalink to this headline"></a></h2>
<p>(Sub)stellar objects of M, L and T types have been extensively studied, such that some empirical spectral indices. Some standard spectral indices have been included in <code class="docutils literal notranslate"><span class="pre">specfit</span></code>. An example is provided below with the H<span class="math notranslate nohighlight">\(_2\)</span>O and Na indices which are relevant for a <span class="math notranslate nohighlight">\(YJH\)</span> spectrum.</p>
<p>It is important to note that different spectral indices are valid in different spectral subtype ranges! The interested reader is referred to the following works: Allers et al. (2007); Bonnefoy et al. (2014) and references therein.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.spec_indices</span> <span class="kn">import</span> <span class="n">spectral_idx</span>

<span class="n">H2O_idx</span> <span class="o">=</span> <span class="n">spectral_idx</span><span class="p">(</span><span class="n">lbda</span><span class="p">,</span> <span class="n">spec_dered</span><span class="p">,</span> <span class="s1">&#39;H2O-1.5&#39;</span><span class="p">,</span> <span class="n">spec_dered_err</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">Na_idx</span> <span class="o">=</span> <span class="n">spectral_idx</span><span class="p">(</span><span class="n">lbda</span><span class="p">,</span> <span class="n">spec_dered</span><span class="p">,</span> <span class="s1">&#39;Na-1.1&#39;</span><span class="p">,</span> <span class="n">spec_dered_err</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;***********************&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;H2O index: &quot;</span><span class="p">,</span><span class="n">H2O_idx</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Na index: &quot;</span><span class="p">,</span><span class="n">Na_idx</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;***********************&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Closest indices to 1.55, 1.56, 1.492 and 1.502 mucorrespond to 1.5436315536499023, 1.562684178352356, 1.4864736795425415 and 1.5055263042449951 resp.
Closest indices to 1.15, 1.16, 1.134 and 1.144 mucorrespond to 1.143526315689087, 1.1625789403915405, 1.1244736909866333 and 1.143526315689087 resp.
***********************
H2O index:  (0.9753922, 0.0068133129230896474)
Na index:  (1.0142473, 0.007491888724907396)
***********************
</pre></div></div>
</div>
<p>The H<span class="math notranslate nohighlight">\(_2\)</span>O index can then be converted to an estimated spectral type:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.spec_indices</span> <span class="kn">import</span> <span class="n">sp_idx_to_spt</span><span class="p">,</span> <span class="n">idx_to_spt</span>

<span class="n">spt</span><span class="p">,</span> <span class="n">spt_err</span> <span class="o">=</span> <span class="n">sp_idx_to_spt</span><span class="p">(</span><span class="n">H2O_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;H2O-1.5&#39;</span><span class="p">,</span> <span class="n">H2O_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">spt_str</span> <span class="o">=</span> <span class="n">idx_to_spt</span><span class="p">(</span><span class="n">spt</span><span class="p">,</span> <span class="n">convention</span><span class="o">=</span><span class="s1">&#39;Allers07&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SpT: </span><span class="si">{}</span><span class="s2">+-</span><span class="si">{:.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spt_str</span><span class="p">,</span> <span class="n">spt_err</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
SpT: M5.1+-0.8
</pre></div></div>
</div>
<p>The Na index on the other hand can be used to estimate the gravity (hence the youth) of an object:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">Na_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.4</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The object&#39;s gravity is consistent with being very young (Na index less than 1.4)&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The Na index does not suggest a very low gravity (i.e. it is unlikely to be very young)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
The object&#39;s gravity is consistent with being very young (Na index less than 1.4)
</pre></div></div>
</div>
<p><a class="reference external" href="#Table-of-contents">Go to the top</a></p>
</div>
</div>
<div class="section" id="4.-MCMC-sampler-examples">
<h1>4. MCMC sampler examples<a class="headerlink" href="#4.-MCMC-sampler-examples" title="Permalink to this headline"></a></h1>
<p>Now let’s fit different models to the observed spectrum of CrA-9 b/B.</p>
<p>In that purpose, let’s first define some parameters that will be common to all MCMC sampler runs on this measured spectrum.</p>
<div class="section" id="4.1.-Parameters">
<h2>4.1. Parameters<a class="headerlink" href="#4.1.-Parameters" title="Permalink to this headline"></a></h2>
<p>Let’s first define the distance to the system, which will be used to scale the models (along with the companion radius):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d_st</span> <span class="o">=</span> <span class="mf">153.</span> <span class="c1">#pc based on Gaia</span>
</pre></div>
</div>
</div>
<p>The internal workings of <code class="docutils literal notranslate"><span class="pre">specfit</span></code> allow for the convolution with the spectral PSF of (in the case of an IFS), or the integration over a filter transmission curve (in the case of photometric points). For these options to be considered, let’s provide the nominal spectral FWHM in nm for IFS (19.15 nm), and the name of the filenames where the filter transmission curves are encoded.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">instru_fwhm</span> <span class="o">=</span> <span class="p">[</span><span class="mf">19.15</span><span class="p">,</span> <span class="c1">#when a float is provided, should be in nm</span>
               <span class="s1">&#39;SPHERE_IRDIS_D_K1.dat&#39;</span><span class="p">,</span>
               <span class="s1">&#39;SPHERE_IRDIS_D_K2.dat&#39;</span><span class="p">,</span>
               <span class="s1">&#39;CONICA_L_prime.dat&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>Now let’s assign an index to each instrument and build a list that will tell the algorithm which instru_fwhm_nm values are to be assigned to which datapoints.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_ifs</span><span class="o">=</span><span class="mi">39</span>
<span class="n">instru_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">n_ifs</span><span class="o">*</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>In addition, we define a snippet function that can read the filter transmissions mentioned in the list. For convenience (and to allow for multiprocessing), it is defined in <code class="docutils literal notranslate"><span class="pre">utils.py</span></code>, and commented below FYI.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">filter_reader</span>

<span class="c1"># import pandas as pd</span>
<span class="c1"># def filter_reader(filename):</span>
<span class="c1">#     # snippet to read filter files and return a tuple: lbda (mu), transmission</span>
<span class="c1">#     filter_path = &quot;../static/filters/&quot;</span>
<span class="c1">#     filt_table = pd.read_csv(filter_path+filename, sep=&#39; &#39;, header=0,</span>
<span class="c1">#                              skipinitialspace=True)</span>
<span class="c1">#     keys = filt_table.keys()</span>
<span class="c1">#     lbda_filt = np.array(filt_table[keys[0]])</span>
<span class="c1">#     if lbda_filt.dtype == &#39;O&#39;:</span>
<span class="c1">#         filt_table = pd.read_csv(filter_path+filename, sep=&#39;\t&#39;, header=0,</span>
<span class="c1">#                                  skipinitialspace=True)</span>
<span class="c1">#         keys = filt_table.keys()</span>
<span class="c1">#         lbda_filt = np.array(filt_table[keys[0]])</span>
<span class="c1">#     elif lbda_filt.dtype == &#39;int32&#39; or lbda_filt.dtype == &#39;int64&#39;:</span>
<span class="c1">#         lbda_filt = np.array(filt_table[keys[0]], dtype=&#39;float64&#39;)</span>
<span class="c1">#     if &#39;(AA)&#39; in keys[0]:</span>
<span class="c1">#         lbda_filt /=10000</span>
<span class="c1">#     elif &#39;(mu)&#39; in keys[0]:</span>
<span class="c1">#         pass</span>
<span class="c1">#     elif &#39;(nm)&#39; in keys[0]:</span>
<span class="c1">#         lbda_filt /=1000</span>
<span class="c1">#     else:</span>
<span class="c1">#         raise ValueError(&#39;Wavelength unit not recognised in filter file&#39;)</span>
<span class="c1">#     trans = np.array(filt_table[keys[1]])</span>
<span class="c1">#     return lbda_filt, trans</span>
</pre></div>
</div>
</div>
<p>Let’s assemble all parameters related to the instrument(s) and filter(s) into a dictionary, including as well the spectral correlation calculated in Sec. 2:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">instru_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;instru_fwhm&#39;</span><span class="p">:</span><span class="n">instru_fwhm</span><span class="p">,</span>
                 <span class="s1">&#39;instru_idx&#39;</span><span class="p">:</span><span class="n">instru_idx</span><span class="p">,</span>
                 <span class="s1">&#39;instru_corr&#39;</span><span class="p">:</span> <span class="n">final_sp_corr</span><span class="p">,</span>
                 <span class="s1">&#39;filter_reader&#39;</span><span class="p">:</span> <span class="n">filter_reader</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">specfit</span></code> was implemented with directly imaged substellar objects in mind. Radii and masses therefore implicitly assume Jovian units. If you prefer Solar radii for your outputs, set <code class="docutils literal notranslate"><span class="pre">star</span></code> to True in the following box:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">c</span>

<span class="n">star</span> <span class="o">=</span> <span class="kc">False</span> <span class="c1"># whether use Solar units</span>
<span class="k">if</span> <span class="n">star</span><span class="p">:</span>
    <span class="n">conv_RS</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">R_jup</span><span class="o">/</span><span class="n">c</span><span class="o">.</span><span class="n">R_sun</span>
    <span class="n">conv_RS</span>
</pre></div>
</div>
</div>
<p>Let’s set the MCMC parameters identically for all runs shown in the next subsections (see more details in <code class="docutils literal notranslate"><span class="pre">emcee</span></code> documentation):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">=</span><span class="mf">2.0</span>
<span class="n">nwalkers</span><span class="o">=</span><span class="mi">100</span>
<span class="n">niteration_min</span><span class="o">=</span><span class="mi">100</span>
<span class="n">niteration_limit</span><span class="o">=</span><span class="mi">500</span> <span class="c1"># recommended&gt;&gt; 1000</span>
<span class="n">nproc</span> <span class="o">=</span> <span class="mi">2</span>            <span class="c1"># number of CPUs</span>

<span class="n">mcmc_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="n">a</span><span class="p">,</span>
               <span class="s1">&#39;nwalkers&#39;</span><span class="p">:</span><span class="n">nwalkers</span><span class="p">,</span>
               <span class="s1">&#39;niteration_min&#39;</span><span class="p">:</span><span class="n">niteration_min</span><span class="p">,</span>
               <span class="s1">&#39;niteration_limit&#39;</span><span class="p">:</span><span class="n">niteration_limit</span><span class="p">,</span>
               <span class="s1">&#39;nproc&#39;</span><span class="p">:</span><span class="n">nproc</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>Similarly, we adopt the autocorrelation time criterion for convergence for all MCMC runs (see more details <a class="reference external" href="https://emcee.readthedocs.io/en/stable/tutorials/autocorr/">here</a>):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">conv_test</span><span class="o">=</span><span class="s1">&#39;ac&#39;</span>
<span class="n">ac_c</span><span class="o">=</span><span class="mi">50</span>
<span class="n">ac_count_thr</span><span class="o">=</span><span class="mi">1</span>

<span class="n">conv_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;conv_test&#39;</span><span class="p">:</span> <span class="n">conv_test</span><span class="p">,</span>
               <span class="s1">&#39;ac_c&#39;</span><span class="p">:</span> <span class="n">ac_c</span><span class="p">,</span>
               <span class="s1">&#39;ac_count_thr&#39;</span><span class="p">:</span><span class="n">ac_count_thr</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>Note that for the purpose of this tutorial, we set a low number of walkers and a low maximum number of iterations. It is recommended to set it large enough (&gt;&gt;1000, depends on number of parameters and model) such that the convergence criterion will break the chain once it is met.</p>
</div>
<div class="section" id="4.2.-Blackbody-model">
<h2>4.2. Blackbody model<a class="headerlink" href="#4.2.-Blackbody-model" title="Permalink to this headline"></a></h2>
<p>This model does not involve any grid:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid_list</span><span class="o">=</span><span class="kc">None</span> <span class="c1"># triggers a blackbody fit</span>
</pre></div>
</div>
</div>
<p>The 2 parameters are the temperature and radius (of a sphere). It is important to label the blackbody temperature and radius ‘Tbb1’ and ‘Rbb1’, respectively. This is because <code class="docutils literal notranslate"><span class="pre">specfit</span></code> allows for the addition of an unlimited number of blackbody components. E.g. for n components, set the labels from ‘Tbb1’ to ‘Tbbn’ and from ‘Rbb1’ to ‘Rbbn’.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Tbb1&#39;</span><span class="p">,</span> <span class="s1">&#39;Rbb1&#39;</span><span class="p">)</span>
<span class="n">units</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$R_J$&#39;</span><span class="p">)</span>

<span class="n">npar</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Set the initial guesses and bounds accordingly. Note the requirement for a Jovian input radius.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ini_guess</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3200.</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">)</span> <span class="c1">#K and R_Jup</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Tbb1&#39;</span><span class="p">:(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">4000</span><span class="p">),</span>
          <span class="s1">&#39;Rbb1&#39;</span><span class="p">:(</span><span class="mf">0.1</span><span class="p">,</span><span class="mi">5</span><span class="p">)}</span>
</pre></div>
</div>
</div>
<p>Again, let’s collate all model-related parameters into a dictionary:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;grid_param_list&#39;</span><span class="p">:</span><span class="n">grid_list</span><span class="p">,</span>
              <span class="s1">&#39;labels&#39;</span><span class="p">:</span><span class="n">labels</span><span class="p">,</span>
              <span class="s1">&#39;initial_state&#39;</span><span class="p">:</span><span class="n">ini_guess</span><span class="p">,</span>
              <span class="s1">&#39;bounds&#39;</span><span class="p">:</span><span class="n">bounds</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>Now let’s run the MCMC sampler (<strong>Warning: the next cell may take a few minutes to complete</strong>):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.mcmc_sampling</span> <span class="kn">import</span> <span class="n">mcmc_spec_sampling</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">mcmc_spec_sampling</span><span class="p">(</span><span class="n">lbda</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">spec_err</span><span class="p">,</span> <span class="n">d_st</span><span class="p">,</span> <span class="n">dlbda_obs</span><span class="o">=</span><span class="n">dlbda</span><span class="p">,</span> <span class="n">units_obs</span><span class="o">=</span><span class="n">units_obs</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">instru_params</span><span class="p">,</span> <span class="o">**</span><span class="n">mcmc_params</span><span class="p">,</span> <span class="o">**</span><span class="n">conv_params</span><span class="p">,</span> <span class="o">**</span><span class="n">model_params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let’s convert the sampled radii into Solar radii:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">final_chain</span><span class="p">,</span> <span class="n">ln_proba</span> <span class="o">=</span> <span class="n">res</span>
<span class="k">if</span> <span class="n">star</span><span class="p">:</span>
    <span class="n">idx_R</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Rbb1&#39;</span><span class="p">)</span>
    <span class="n">final_chain</span><span class="p">[:,:,</span><span class="n">idx_R</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_chain</span><span class="p">[:,:,</span><span class="n">idx_R</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">conv_RS</span>
    <span class="c1"># change units of radius</span>
    <span class="n">units</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
    <span class="n">units</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$R_{\odot}$&#39;</span>
    <span class="n">units</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let’s inspect the walk plot:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.mcmc_sampling</span> <span class="kn">import</span> <span class="n">show_walk_plot</span>

<span class="n">show_walk_plot</span><span class="p">(</span><span class="n">final_chain</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span><span class="c1">#, save=False,# output_dir=&#39;../datasets/&#39;,</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_98_0.png" src="../_images/tutorials_walkthrough_98_0.png" />
</div>
</div>
<p>If you wish to save the walk plot in a pdf, set <code class="docutils literal notranslate"><span class="pre">save=True</span></code> and provide a value for the output directory (<code class="docutils literal notranslate"><span class="pre">output_dir</span></code>).</p>
<p>Based on the walk plot, let’s define a conservative burnin factor of 0.3 and apply it to the chain:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">burnin</span><span class="o">=</span><span class="mf">0.3</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cutoff</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">final_chain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">burnin</span><span class="p">))</span>
<span class="n">ngood_steps</span> <span class="o">=</span> <span class="n">final_chain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">cutoff</span>
<span class="n">samples_flat_BB</span> <span class="o">=</span> <span class="n">final_chain</span><span class="p">[:,</span> <span class="n">cutoff</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">npar</span><span class="p">))</span>
<span class="c1">#write_fits(output_dir+&quot;isamples_flat.fits&quot;,isamples_flat)</span>
</pre></div>
</div>
</div>
<p>Let’s compute the 68.27% confidence intervals on the posterior distribution, after burnin:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.mcmc_sampling</span> <span class="kn">import</span> <span class="n">confidence</span>

<span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">vals</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">confidence</span><span class="p">(</span><span class="n">samples_flat_BB</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">cfd</span><span class="o">=</span><span class="mf">68.27</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
                            <span class="n">gaussian_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                            <span class="n">priors</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
percentage for Tbb1: 69.8342857142857%
percentage for Rbb1: 69.06571428571428%
******* Results for Tbb1 *****


Confidence intervals:
Tbb1: 2580.0997243264624 [-16.642569965393704,16.642569965393704]
******* Results for Rbb1 *****


Confidence intervals:
Rbb1: 0.7368989458909917 [-0.00795331915859332,0.012498072963503915]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_104_1.png" src="../_images/tutorials_walkthrough_104_1.png" />
</div>
</div>
<p>If you wish to save the results in a text file, set <code class="docutils literal notranslate"><span class="pre">save=True</span></code> and provide a value for the output directory (<code class="docutils literal notranslate"><span class="pre">output_dir</span></code>).</p>
<p>Let’s define the most likely parameters along with their uncertainties in a numpy array:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">post_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">npar</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npar</span><span class="p">):</span>
    <span class="n">post_params</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
    <span class="n">post_params</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">err</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">post_params</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">err</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>Now, let’s have a look at the corner plot. A couple of parameters can be fine tuned for aesthetics, e.g.:</p>
<ul class="simple">
<li><p>number of significant digits for each parameter (<code class="docutils literal notranslate"><span class="pre">ndig</span></code>),</p></li>
<li><p>labels to be used in the plot for each parameter (<code class="docutils literal notranslate"><span class="pre">labels_plot</span></code> can be different to the string used in <code class="docutils literal notranslate"><span class="pre">labels</span></code> but <code class="docutils literal notranslate"><span class="pre">labels</span></code> is used if not provided),</p></li>
<li><p>font attributes for plot title and label,</p></li>
<li><p>number of bins to consider for the corner plot histograms.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ndig</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># should have same length as labels</span>
<span class="n">labels_plot</span> <span class="o">=</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$T$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$R$&#39;</span><span class="p">)</span>
<span class="n">title_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fontsize&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">}</span>
<span class="n">label_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fontsize&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">}</span>
<span class="n">corner_bins</span> <span class="o">=</span> <span class="mi">20</span>
</pre></div>
</div>
</div>
<p>If you wish to save the corner plot in pdf format, set <code class="docutils literal notranslate"><span class="pre">save=True</span></code> and provide a value to <code class="docutils literal notranslate"><span class="pre">plot_name</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.mcmc_sampling</span> <span class="kn">import</span> <span class="n">show_corner_plot</span>

<span class="c1">#note: provide the chain before burnin, since burnin is done internally here:</span>
<span class="n">show_corner_plot</span><span class="p">(</span><span class="n">final_chain</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="n">burnin</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">mcmc_res</span><span class="o">=</span><span class="n">post_params</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">ndig</span><span class="o">=</span><span class="n">ndig</span><span class="p">,</span> <span class="n">labels_plot</span><span class="o">=</span><span class="n">labels_plot</span><span class="p">,</span>
                      <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="c1">#plot_name=&#39;corner_plot.pdf&#39;,</span>
                      <span class="n">title_kwargs</span><span class="o">=</span><span class="n">title_kwargs</span><span class="p">,</span> <span class="n">label_kwargs</span><span class="o">=</span><span class="n">label_kwargs</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">corner_bins</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_111_0.png" src="../_images/tutorials_walkthrough_111_0.png" />
</div>
</div>
<p>As expected, the 2 parameters are highly dependent on each other. With only 2 parameters, we also note that the estimated uncertainties on each parameter are very small. As we will see, with a more realistic model including more parameters, the uncertainties on each parameter widens.</p>
<p>Let’s save the likelihood and parameter values of the most likely model for later (<a class="reference external" href="#5.2.-Best-fit-models">Sec. 5.2</a>):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># favoured model has highest likelihood</span>
<span class="n">max_prob_BB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">ln_proba</span><span class="p">)</span>
<span class="n">idx_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span><span class="n">ln_proba</span><span class="p">),</span><span class="n">shape</span><span class="o">=</span><span class="n">ln_proba</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">bf_params_BB</span> <span class="o">=</span> <span class="n">final_chain</span><span class="p">[</span><span class="n">idx_max</span><span class="p">]</span>
<span class="n">bf_params_BB</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([2.58147810e+03, 7.39635865e-01])
</pre></div></div>
</div>
</div>
<div class="section" id="4.3.-BT-SETTL-model">
<h2>4.3. BT-SETTL model<a class="headerlink" href="#4.3.-BT-SETTL-model" title="Permalink to this headline"></a></h2>
<p>Let’s now consider a grid of BT-SETTL models. In addition, let’s also consider extinction as a free parameter, since for young objects it is possible that different amounts of dust surround the companion than the central star.</p>
<p>In the case of BT-SETTL models, there are 2 free parameters in the grid: effective temperature and surface gravity. Let’s define the grid of parameter values covered by the models in our possession (in the <code class="docutils literal notranslate"><span class="pre">models/btsettl15/</span></code> directory).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">teff_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">4000</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">21</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">logg_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span><span class="mf">5.5</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">grid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">teff_list</span><span class="p">,</span> <span class="n">logg_list</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>Let’s now define a snippet function that can read the input files of the grid, and provide as output a tuple of 2 vectors (1d arrays) for the wavelength and flux (in SI units, at the surface of the object). For convenience (and to allow for multiprocessing), it is defined in <code class="docutils literal notranslate"><span class="pre">utils.py</span></code>, and commented below FYI.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">bts_reader</span>
<span class="c1"># def bts_reader(params):</span>
<span class="c1">#     # snippet to read BT-SETTL fits files and return a tuple: lbda (mu), spec (SI)</span>
<span class="c1">#     mod_units = &#39;cgs&#39; # careful: input in cgs</span>
<span class="c1">#     mod_path = &#39;../static/btsettl15_models/&#39;</span>
<span class="c1">#     filename = mod_path+&#39;btsettl15_t{:.0f}_g{:.1f}0_z-0.00_SPEX-PRISM.txt&#39;.format(params[0],params[1])</span>
<span class="c1">#     lbda = []</span>
<span class="c1">#     flux = []</span>
<span class="c1">#     f=open(filename,&quot;r&quot;)</span>
<span class="c1">#     lines=f.readlines()</span>
<span class="c1">#     for i, x in enumerate(lines):</span>
<span class="c1">#         if i&gt;0:</span>
<span class="c1">#             lbda.append(float(x.split(&#39;\t&#39;)[0]))</span>
<span class="c1">#             flux.append(float(x.split(&#39;\t&#39;)[1]))</span>
<span class="c1">#     f.close()</span>

<span class="c1">#     # Correct for atmospheric refraction</span>
<span class="c1">#     flux = np.array(flux)</span>
<span class="c1">#     lbda = np.array(lbda)</span>
<span class="c1">#     nref = nrefrac(lbda*1e4)</span>
<span class="c1">#     lbda = lbda/(1+(nref*1e-6))</span>

<span class="c1">#     #conversion from ergs/s/cm2/um to W/m2/um</span>
<span class="c1">#     flux = convert_F_units(flux, lbda, in_unit=mod_units, out_unit=&#39;si&#39;)</span>

<span class="c1">#     return lbda, flux</span>
</pre></div>
</div>
</div>
<p>Since the snippet function already performs the conversion to SI flux units (W m<span class="math notranslate nohighlight">\(^{-2}\)</span>), we will the model units to ‘si’. Note that ‘cgs’ units or ‘jy’ are also accepted - the conversion to match the observed flux would then be made internally.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">units_mod</span> <span class="o">=</span> <span class="s1">&#39;si&#39;</span>
</pre></div>
</div>
</div>
<p>Considering also the extinction <code class="docutils literal notranslate"><span class="pre">A_V</span></code> as a free parameter, we have a total of 4 free parameters, including 2 captured by the grid:</p>
<p>The 2 parameters are the temperature and radius (of a sphere). It is important to label the blackbody temperature and radius ‘Tbb1’ and ‘Rbb1’, respectively. This is because <code class="docutils literal notranslate"><span class="pre">specfit</span></code> allows for the addition of an unlimited number of blackbody components. E.g. for n components, set the labels from ‘Tbb1’ to ‘Tbbn’ and from ‘Rbb1’ to ‘Rbbn’.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Teff&#39;</span><span class="p">,</span> <span class="s1">&#39;logg&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;Av&#39;</span><span class="p">)</span>
<span class="n">units</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$R_J$&#39;</span><span class="p">,</span> <span class="s1">&#39;mag&#39;</span><span class="p">)</span>

<span class="n">npar</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Set the initial guesses and bounds accordingly. Note the requirement for a Jovian input radius.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ini_guess</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3100.</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">)</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Teff&#39;</span><span class="p">:(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">4000</span><span class="p">),</span>
          <span class="s1">&#39;logg&#39;</span><span class="p">:(</span><span class="mf">2.5</span><span class="p">,</span><span class="mf">5.5</span><span class="p">),</span>
          <span class="s1">&#39;R&#39;</span><span class="p">:(</span><span class="mf">0.1</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
          <span class="s1">&#39;Av&#39;</span><span class="p">:(</span><span class="mf">0.</span><span class="p">,</span><span class="mi">5</span><span class="p">)}</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;grid_param_list&#39;</span><span class="p">:</span><span class="n">grid_list</span><span class="p">,</span>
              <span class="s1">&#39;model_reader&#39;</span><span class="p">:</span><span class="n">bts_reader</span><span class="p">,</span>
              <span class="s1">&#39;labels&#39;</span><span class="p">:</span><span class="n">labels</span><span class="p">,</span>
              <span class="s1">&#39;initial_state&#39;</span><span class="p">:</span><span class="n">ini_guess</span><span class="p">,</span>
              <span class="s1">&#39;bounds&#39;</span><span class="p">:</span><span class="n">bounds</span><span class="p">,</span>
              <span class="s1">&#39;units_mod&#39;</span><span class="p">:</span><span class="n">units_mod</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>In order for the MCMC sampler to run faster, all models of the grid are first resampled (at the same sampling as the measured spectrum), such that only light spectra files are opened and interpolated during the sampling. To do so, set <code class="docutils literal notranslate"><span class="pre">resamp_before=True</span></code> and provide a path and name where the resampled grid will be saved:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid_name</span><span class="o">=</span><span class="s1">&#39;bts_resamp_grid.fits&#39;</span>
<span class="n">output_dir</span><span class="o">=</span><span class="s1">&#39;../static/bts_output/&#39;</span>
<span class="n">resamp_before</span><span class="o">=</span><span class="kc">True</span>
</pre></div>
</div>
</div>
<p><strong>Important</strong>: if a file named <code class="docutils literal notranslate"><span class="pre">output_dir</span></code>+<code class="docutils literal notranslate"><span class="pre">grid_name</span></code> already exists it will be used, instead of creating a new resmpled grid (this is to save time when a given MCMC sampling is performed multiple times with different options). Make sure to change either <code class="docutils literal notranslate"><span class="pre">output_dir</span></code> or <code class="docutils literal notranslate"><span class="pre">grid_name</span></code> when considering different models or a different range of parameter values in the grid (i.e. differente <code class="docutils literal notranslate"><span class="pre">grid_list</span></code>).</p>
<p>We also set a filename where the MCMC results will be written as a pickle, such that they can be accessed without having to run again the MCMC.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;MCMC_results&#39;</span> <span class="c1"># also written in output_dir</span>

<span class="n">output_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;resamp_before&#39;</span><span class="p">:</span><span class="n">resamp_before</span><span class="p">,</span>
                 <span class="s1">&#39;grid_name&#39;</span><span class="p">:</span><span class="n">grid_name</span><span class="p">,</span>
                 <span class="s1">&#39;output_dir&#39;</span><span class="p">:</span> <span class="n">output_dir</span><span class="p">,</span>
                 <span class="s1">&#39;output_file&#39;</span><span class="p">:</span> <span class="n">output_file</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>Now let’s run the MCMC sampler (<strong>Warning: the next cell may take a few minutes to complete</strong>):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.mcmc_sampling</span> <span class="kn">import</span> <span class="n">mcmc_spec_sampling</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">mcmc_spec_sampling</span><span class="p">(</span><span class="n">lbda</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">spec_err</span><span class="p">,</span> <span class="n">d_st</span><span class="p">,</span> <span class="n">dlbda_obs</span><span class="o">=</span><span class="n">dlbda</span><span class="p">,</span>
                                      <span class="o">**</span><span class="n">instru_params</span><span class="p">,</span> <span class="o">**</span><span class="n">mcmc_params</span><span class="p">,</span> <span class="o">**</span><span class="n">conv_params</span><span class="p">,</span>
                                      <span class="o">**</span><span class="n">model_params</span><span class="p">,</span> <span class="o">**</span><span class="n">output_params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Fits HDU-0 data successfully loaded. Data shape: (21, 7, 42, 2)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">final_chain</span><span class="p">,</span> <span class="n">ln_proba</span> <span class="o">=</span> <span class="n">res</span>
<span class="k">if</span> <span class="n">star</span><span class="p">:</span>
    <span class="n">idx_R</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">)</span>
    <span class="n">final_chain</span><span class="p">[:,:,</span><span class="n">idx_R</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_chain</span><span class="p">[:,:,</span><span class="n">idx_R</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">conv_RS</span>
    <span class="c1"># change units of radius</span>
    <span class="n">units</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
    <span class="n">units</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$R_{\odot}$&#39;</span>
    <span class="n">units</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let’s inspect the walk plot:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.mcmc_sampling</span> <span class="kn">import</span> <span class="n">show_walk_plot</span>

<span class="n">show_walk_plot</span><span class="p">(</span><span class="n">final_chain</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span><span class="c1">#, save=False,# output_dir=&#39;../datasets/&#39;,</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_138_0.png" src="../_images/tutorials_walkthrough_138_0.png" />
</div>
</div>
<p>If you wish to save the walk plot in a pdf, set <code class="docutils literal notranslate"><span class="pre">save=True</span></code> and provide a value for the output directory (<code class="docutils literal notranslate"><span class="pre">output_dir</span></code>).</p>
<p>Based on the walk plot, let’s define a conservative burnin factor of 0.3 and apply it to the chain:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">burnin</span><span class="o">=</span><span class="mf">0.3</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[59]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cutoff</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">final_chain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">burnin</span><span class="p">))</span>
<span class="n">ngood_steps</span> <span class="o">=</span> <span class="n">final_chain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">cutoff</span>
<span class="n">samples_flat_BTS</span> <span class="o">=</span> <span class="n">final_chain</span><span class="p">[:,</span> <span class="n">cutoff</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">npar</span><span class="p">))</span>
<span class="c1">#write_fits(output_dir+&quot;isamples_flat.fits&quot;,isamples_flat)</span>
</pre></div>
</div>
</div>
<p>Let’s compute the 68.27% confidence intervals on the posterior distribution, after burnin:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[60]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.mcmc_sampling</span> <span class="kn">import</span> <span class="n">confidence</span>

<span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">vals</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">confidence</span><span class="p">(</span><span class="n">samples_flat_BTS</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">cfd</span><span class="o">=</span><span class="mf">68.27</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
                            <span class="n">gaussian_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                            <span class="n">priors</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
percentage for Teff: 69.44857142857143%
percentage for logg: 69.61142857142858%
percentage for R: 68.72571428571429%
percentage for Av: 69.00285714285715%
******* Results for Teff *****


Confidence intervals:
Teff: 3169.231372943627 [-48.47753170626402,38.447697560140114]
******* Results for logg *****


Confidence intervals:
logg: 5.00038218244958 [-0.19114552865797219,0.26513734620299445]
******* Results for R *****


Confidence intervals:
R: 0.5603655752590516 [-0.01004829450629352,0.009244430945790083]
******* Results for Av *****


Confidence intervals:
Av: 1.8090257283773643 [-0.08833250939842485,0.052999505639054645]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_144_1.png" src="../_images/tutorials_walkthrough_144_1.png" />
</div>
</div>
<p>If you wish to save the results in a text file, set <code class="docutils literal notranslate"><span class="pre">save=True</span></code> and provide a value for the output directory (<code class="docutils literal notranslate"><span class="pre">output_dir</span></code>).</p>
<p>Let’s define the most likely parameters along with their uncertainties in a numpy array:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">post_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">npar</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npar</span><span class="p">):</span>
    <span class="n">post_params</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
    <span class="n">post_params</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">err</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">post_params</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">err</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>Now, let’s have a look at the corner plot. A couple of parameters can be fine tuned for aesthetics, e.g.:</p>
<ul class="simple">
<li><p>number of significant digits for each parameter (<code class="docutils literal notranslate"><span class="pre">ndig</span></code>),</p></li>
<li><p>labels to be used in the plot for each parameter (<code class="docutils literal notranslate"><span class="pre">labels_plot</span></code> can be different to the string used in <code class="docutils literal notranslate"><span class="pre">labels</span></code> but <code class="docutils literal notranslate"><span class="pre">labels</span></code> is used if not provided),</p></li>
<li><p>font attributes for plot title and label,</p></li>
<li><p>number of bins to consider for the corner plot histograms.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[62]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ndig</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># should have same length as labels</span>
<span class="n">labels_plot</span> <span class="o">=</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$T$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;log($g$)&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$R$&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;$A_V$&#39;</span><span class="p">)</span>
<span class="n">title_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fontsize&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">}</span>
<span class="n">label_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fontsize&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">}</span>
<span class="n">corner_bins</span> <span class="o">=</span> <span class="mi">20</span>
</pre></div>
</div>
</div>
<p>If you wish to save the corner plot in pdf format, set <code class="docutils literal notranslate"><span class="pre">save=True</span></code> and provide a value to <code class="docutils literal notranslate"><span class="pre">plot_name</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[63]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.mcmc_sampling</span> <span class="kn">import</span> <span class="n">show_corner_plot</span>

<span class="c1">#note: provide the chain before burnin, since burnin is done internally here:</span>
<span class="n">show_corner_plot</span><span class="p">(</span><span class="n">final_chain</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="n">burnin</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">mcmc_res</span><span class="o">=</span><span class="n">post_params</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">ndig</span><span class="o">=</span><span class="n">ndig</span><span class="p">,</span> <span class="n">labels_plot</span><span class="o">=</span><span class="n">labels_plot</span><span class="p">,</span>
                      <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="c1">#plot_name=&#39;corner_plot.pdf&#39;,</span>
                      <span class="n">title_kwargs</span><span class="o">=</span><span class="n">title_kwargs</span><span class="p">,</span> <span class="n">label_kwargs</span><span class="o">=</span><span class="n">label_kwargs</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">corner_bins</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_151_0.png" src="../_images/tutorials_walkthrough_151_0.png" />
</div>
</div>
<p>Let’s save the likelihood and parameter values of the most likely model for later (<a class="reference external" href="#5.2.-Best-fit-models">Sec. 5.2</a>):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[64]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># favoured model has highest likelihood</span>
<span class="n">max_prob_BTS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">ln_proba</span><span class="p">)</span>
<span class="n">idx_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span><span class="n">ln_proba</span><span class="p">),</span><span class="n">shape</span><span class="o">=</span><span class="n">ln_proba</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">bf_params_BTS</span> <span class="o">=</span> <span class="n">final_chain</span><span class="p">[</span><span class="n">idx_max</span><span class="p">]</span>
<span class="n">bf_params_BTS</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[64]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([3.16449482e+03, 5.00849672e+00, 5.61779329e-01, 1.80778235e+00])
</pre></div></div>
</div>
<p>The results above are puzzling: a ~3000 K effective temperature combined with a ~0.5 <span class="math notranslate nohighlight">\(R_J\)</span> photometric radius. See Christiaens et al. (2021) for a discussion on the different hypotheses put forward to reconcile these results.</p>
</div>
<div class="section" id="4.4.-BT-SETTL-+-BB-model">
<h2>4.4. BT-SETTL + BB model<a class="headerlink" href="#4.4.-BT-SETTL-+-BB-model" title="Permalink to this headline"></a></h2>
<p>Although this is not necessarily a good model for the NIR spectrum of CrA-9 B/b, let’s illustrate how to set up a photospheric + extra blackbody component model to further showcase the possibilities available in <code class="docutils literal notranslate"><span class="pre">specfit</span></code>.</p>
<p>Let’s set Gaussian priors on the temperatures of each Blackbody component, to replicate the kinds of constraints that could potentially be obtained from past works.</p>
<p>Note that a single extra BB component is considered here, but <code class="docutils literal notranslate"><span class="pre">specfit</span></code> does not limit the number of components you wish to incorporate in the model (just add the desired number of parameters ‘Tbb<em>n</em>’ and ‘Rbb<em>n</em>’, where <em>n</em>&gt;0).</p>
<p>This time, we have a total of 8 free parameters, including 2 captured by the BT-SETTL grid:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Teff&#39;</span><span class="p">,</span> <span class="s1">&#39;logg&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;Av&#39;</span><span class="p">,</span> <span class="s1">&#39;Tbb1&#39;</span><span class="p">,</span> <span class="s1">&#39;Rbb1&#39;</span><span class="p">)</span>
<span class="n">units</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$R_J$&#39;</span><span class="p">,</span> <span class="s1">&#39;mag&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$R_J$&#39;</span><span class="p">)</span>
<span class="n">npar</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

<span class="n">teff_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">4000</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">21</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">logg_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span><span class="mf">5.5</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">grid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">teff_list</span><span class="p">,</span> <span class="n">logg_list</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>Set the initial guesses and bounds accordingly. Note the requirement for a Jovian input radius.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ini_guess</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3100.</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">,</span> <span class="mi">1100</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Teff&#39;</span><span class="p">:(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">4000</span><span class="p">),</span>
          <span class="s1">&#39;logg&#39;</span><span class="p">:(</span><span class="mf">2.5</span><span class="p">,</span><span class="mf">5.5</span><span class="p">),</span>
          <span class="s1">&#39;R&#39;</span><span class="p">:(</span><span class="mf">0.1</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
          <span class="s1">&#39;Av&#39;</span><span class="p">:(</span><span class="mf">0.</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
          <span class="s1">&#39;Tbb1&#39;</span><span class="p">:(</span><span class="mi">900</span><span class="p">,</span><span class="mi">2000</span><span class="p">),</span>
          <span class="s1">&#39;Rbb1&#39;</span><span class="p">:(</span><span class="mf">0.1</span><span class="p">,</span><span class="mi">5</span><span class="p">)}</span>
</pre></div>
</div>
</div>
<p>Let’s set Gaussian priors for log(<span class="math notranslate nohighlight">\(g\)</span>), <span class="math notranslate nohighlight">\(T_{bb1}\)</span> and <span class="math notranslate nohighlight">\(T_{bb2}\)</span> in a dictionary. By default, uniform priors are considered for parameters not mentioned in this dictionary. Be sure to use the same dictionary labels as for parameter <code class="docutils literal notranslate"><span class="pre">labels</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[67]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">priors</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;logg&#39;</span><span class="p">:(</span><span class="mf">3.5</span><span class="p">,</span><span class="mf">0.2</span><span class="p">),</span>
          <span class="s1">&#39;Tbb1&#39;</span><span class="p">:(</span><span class="mi">1200</span><span class="p">,</span><span class="mi">200</span><span class="p">)}</span>
</pre></div>
</div>
</div>
<p>When including a blackbody component, you can ensure that the sampled solutions are physical (e.g. the BB temperatures must systematically be lower temperature than the photosphere effective temperature - assuming it comes from surrounding heated dust):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">physical</span><span class="o">=</span><span class="kc">True</span>
</pre></div>
</div>
</div>
<p>It is also possible to tell the model whether to apply the extinction before or after adding the blackbody component, depending on where the dust absorbing the companion signal is to be assumed with respect to the emitting dust. By default, we assume the latter (e.g. interstellar dust).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">AV_bef_bb</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
</div>
<p>Let’s compile all model-related parameters defined above into a dictionary:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;grid_param_list&#39;</span><span class="p">:</span><span class="n">grid_list</span><span class="p">,</span>
              <span class="s1">&#39;model_reader&#39;</span><span class="p">:</span><span class="n">bts_reader</span><span class="p">,</span>
              <span class="s1">&#39;labels&#39;</span><span class="p">:</span><span class="n">labels</span><span class="p">,</span>
              <span class="s1">&#39;initial_state&#39;</span><span class="p">:</span><span class="n">ini_guess</span><span class="p">,</span>
              <span class="s1">&#39;bounds&#39;</span><span class="p">:</span><span class="n">bounds</span><span class="p">,</span>
              <span class="s1">&#39;priors&#39;</span><span class="p">:</span><span class="n">priors</span><span class="p">,</span>
              <span class="s1">&#39;units_mod&#39;</span><span class="p">:</span><span class="n">units_mod</span><span class="p">,</span>
              <span class="s1">&#39;physical&#39;</span><span class="p">:</span><span class="n">physical</span><span class="p">,</span>
              <span class="s1">&#39;AV_bef_bb&#39;</span><span class="p">:</span><span class="n">AV_bef_bb</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>In order for the MCMC sampler to run faster, all models of the grid are first resampled (at the same sampling as the measured spectrum), such that only light spectra files are opened and interpolated during the sampling. To do so, set <code class="docutils literal notranslate"><span class="pre">resamp_before=True</span></code> and provide a path and name where the resampled grid will be saved:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid_name</span><span class="o">=</span><span class="s1">&#39;bts_bb_resamp_grid.fits&#39;</span>
<span class="n">output_dir</span><span class="o">=</span><span class="s1">&#39;../static/bts_output/&#39;</span>
<span class="n">resamp_before</span><span class="o">=</span><span class="kc">True</span>
</pre></div>
</div>
</div>
<p><strong>Important</strong>: if a file named <code class="docutils literal notranslate"><span class="pre">output_dir</span></code>+<code class="docutils literal notranslate"><span class="pre">grid_name</span></code> already exists it will be used, instead of creating a new resmpled grid (this is to save time when a given MCMC sampling is performed multiple times with different options). Make sure to change either <code class="docutils literal notranslate"><span class="pre">output_dir</span></code> or <code class="docutils literal notranslate"><span class="pre">grid_name</span></code> when considering different models or a different range of parameter values in the grid (i.e. different <code class="docutils literal notranslate"><span class="pre">grid_list</span></code>).</p>
<p>We also set a filename where the MCMC results will be written as a pickle, such that they can be accessed without having to run again the MCMC.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;MCMC_results_bb&#39;</span> <span class="c1"># also written in output_dir</span>

<span class="n">output_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;resamp_before&#39;</span><span class="p">:</span><span class="n">resamp_before</span><span class="p">,</span>
                 <span class="s1">&#39;grid_name&#39;</span><span class="p">:</span><span class="n">grid_name</span><span class="p">,</span>
                 <span class="s1">&#39;output_dir&#39;</span><span class="p">:</span> <span class="n">output_dir</span><span class="p">,</span>
                 <span class="s1">&#39;output_file&#39;</span><span class="p">:</span> <span class="n">output_file</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>Finally, given the larger number of parameters, let’s increase the number of iterations and walkers:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">=</span><span class="mf">2.0</span>
<span class="n">nwalkers</span><span class="o">=</span><span class="mi">200</span>
<span class="n">niteration_min</span><span class="o">=</span><span class="mi">100</span>
<span class="n">niteration_limit</span><span class="o">=</span><span class="mi">1000</span> <span class="c1"># recommended&gt;&gt; 1000</span>
<span class="n">nproc</span> <span class="o">=</span> <span class="mi">2</span>             <span class="c1"># number of CPUs</span>

<span class="n">mcmc_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="n">a</span><span class="p">,</span>
               <span class="s1">&#39;nwalkers&#39;</span><span class="p">:</span><span class="n">nwalkers</span><span class="p">,</span>
               <span class="s1">&#39;niteration_min&#39;</span><span class="p">:</span><span class="n">niteration_min</span><span class="p">,</span>
               <span class="s1">&#39;niteration_limit&#39;</span><span class="p">:</span><span class="n">niteration_limit</span><span class="p">,</span>
               <span class="s1">&#39;nproc&#39;</span><span class="p">:</span><span class="n">nproc</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>Now let’s run the MCMC sampler (<strong>Warning: the next cell may take a few minutes to complete</strong>):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.mcmc_sampling</span> <span class="kn">import</span> <span class="n">mcmc_spec_sampling</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">mcmc_spec_sampling</span><span class="p">(</span><span class="n">lbda</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">spec_err</span><span class="p">,</span> <span class="n">d_st</span><span class="p">,</span> <span class="n">dlbda_obs</span><span class="o">=</span><span class="n">dlbda</span><span class="p">,</span> <span class="n">units_obs</span><span class="o">=</span><span class="n">units_obs</span><span class="p">,</span>
                                      <span class="o">**</span><span class="n">instru_params</span><span class="p">,</span> <span class="o">**</span><span class="n">mcmc_params</span><span class="p">,</span> <span class="o">**</span><span class="n">conv_params</span><span class="p">,</span> <span class="o">**</span><span class="n">model_params</span><span class="p">,</span> <span class="o">**</span><span class="n">output_params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Fits HDU-0 data successfully loaded. Data shape: (21, 7, 42, 2)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">final_chain</span><span class="p">,</span> <span class="n">ln_proba</span> <span class="o">=</span> <span class="n">res</span>
<span class="k">if</span> <span class="n">star</span><span class="p">:</span>
    <span class="n">idx_R</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">)</span>
    <span class="n">final_chain</span><span class="p">[:,:,</span><span class="n">idx_R</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_chain</span><span class="p">[:,:,</span><span class="n">idx_R</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">conv_RS</span>
    <span class="c1"># change units of radius</span>
    <span class="n">units</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
    <span class="n">units</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$R_{\odot}$&#39;</span>
    <span class="n">units</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let’s inspect the walk plot:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[76]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.mcmc_sampling</span> <span class="kn">import</span> <span class="n">show_walk_plot</span>

<span class="n">show_walk_plot</span><span class="p">(</span><span class="n">final_chain</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span><span class="c1">#, save=False,# output_dir=&#39;../datasets/&#39;,</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_180_0.png" src="../_images/tutorials_walkthrough_180_0.png" />
</div>
</div>
<p>If you wish to save the walk plot in a pdf, set <code class="docutils literal notranslate"><span class="pre">save=True</span></code> and provide a value for the output directory (<code class="docutils literal notranslate"><span class="pre">output_dir</span></code>).</p>
<p>Based on the walk plot, let’s define a conservative burnin factor of 0.5 and apply it to the chain:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[77]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">burnin</span><span class="o">=</span><span class="mf">0.5</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cutoff</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">final_chain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">burnin</span><span class="p">))</span>
<span class="n">ngood_steps</span> <span class="o">=</span> <span class="n">final_chain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">cutoff</span>
<span class="n">samples_flat_BTS_BB</span> <span class="o">=</span> <span class="n">final_chain</span><span class="p">[:,</span> <span class="n">cutoff</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">npar</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>Let’s compute the 68.27% confidence intervals on the posterior distribution, after burnin:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[79]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.mcmc_sampling</span> <span class="kn">import</span> <span class="n">confidence</span>

<span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">vals</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">confidence</span><span class="p">(</span><span class="n">samples_flat_BTS_BB</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">cfd</span><span class="o">=</span><span class="mf">68.27</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
                            <span class="n">gaussian_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                            <span class="n">priors</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
percentage for Teff: 69.29100000000001%
percentage for logg: 69.86099999999999%
percentage for R: 68.563%
percentage for Av: 69.91000000000001%
percentage for Tbb1: 68.60499999999999%
percentage for Rbb1: 69.15699999999998%
******* Results for Teff *****


Confidence intervals:
Teff: 3141.0563510171787 [-47.47021410888192,34.37498263056932]
******* Results for logg *****


Confidence intervals:
logg: 4.142693617992571 [-0.14631340453420538,0.12743425556205068]
******* Results for R *****


Confidence intervals:
R: 0.48102491944429965 [-0.011803034757999376,0.02050000773757782]
******* Results for Av *****


Confidence intervals:
Av: 0.9435293321920638 [-0.10997445498162195,0.20258452233456692]
******* Results for Tbb1 *****


Confidence intervals:
Tbb1: 1643.5708063199083 [-121.60288721804591,121.60288721804568]
******* Results for Rbb1 *****


Confidence intervals:
Rbb1: 0.7695322046512436 [-0.0814893021134484,0.11408502295882794]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_186_1.png" src="../_images/tutorials_walkthrough_186_1.png" />
</div>
</div>
<p>If you wish to save the results in a text file, set <code class="docutils literal notranslate"><span class="pre">save=True</span></code> and provide a value for the output directory (<code class="docutils literal notranslate"><span class="pre">output_dir</span></code>).</p>
<p>Let’s define the most likely parameters along with their uncertainties in a numpy array:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[80]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">post_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">npar</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npar</span><span class="p">):</span>
    <span class="n">post_params</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
    <span class="n">post_params</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">err</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">post_params</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">err</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>Now, let’s have a look at the corner plot. A couple of parameters can be fine tuned for aesthetics, e.g.:</p>
<ul class="simple">
<li><p>number of significant digits for each parameter (<code class="docutils literal notranslate"><span class="pre">ndig</span></code>),</p></li>
<li><p>labels to be used in the plot for each parameter (<code class="docutils literal notranslate"><span class="pre">labels_plot</span></code> can be different to the string used in <code class="docutils literal notranslate"><span class="pre">labels</span></code> but <code class="docutils literal notranslate"><span class="pre">labels</span></code> is used if not provided),</p></li>
<li><p>font attributes for plot title and label,</p></li>
<li><p>number of bins to consider for the corner plot histograms.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[81]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ndig</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># should have same length as labels</span>
<span class="n">labels_plot</span> <span class="o">=</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$T$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;log($g$)&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$R$&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;$A_V$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$T_</span><span class="si">{bb1}</span><span class="s1">$&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;$R_</span><span class="si">{bb1}</span><span class="s1">$&#39;</span><span class="p">)</span>
<span class="n">title_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fontsize&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">}</span>
<span class="n">label_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fontsize&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">}</span>
<span class="n">corner_bins</span> <span class="o">=</span> <span class="mi">20</span>
</pre></div>
</div>
</div>
<p>If you wish to save the corner plot in pdf format, set <code class="docutils literal notranslate"><span class="pre">save=True</span></code> and provide a value to <code class="docutils literal notranslate"><span class="pre">plot_name</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[82]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.mcmc_sampling</span> <span class="kn">import</span> <span class="n">show_corner_plot</span>

<span class="c1">#note: provide the chain before burnin, since burnin is done internally here:</span>
<span class="n">show_corner_plot</span><span class="p">(</span><span class="n">final_chain</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="n">burnin</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">mcmc_res</span><span class="o">=</span><span class="n">post_params</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">ndig</span><span class="o">=</span><span class="n">ndig</span><span class="p">,</span> <span class="n">labels_plot</span><span class="o">=</span><span class="n">labels_plot</span><span class="p">,</span>
                      <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="c1">#plot_name=&#39;corner_plot.pdf&#39;,</span>
                      <span class="n">title_kwargs</span><span class="o">=</span><span class="n">title_kwargs</span><span class="p">,</span> <span class="n">label_kwargs</span><span class="o">=</span><span class="n">label_kwargs</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">corner_bins</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_193_0.png" src="../_images/tutorials_walkthrough_193_0.png" />
</div>
</div>
<p>Let’s save the likelihood and parameter values of the most likely model for later (<a class="reference external" href="#5.2.-Best-fit-models">Sec. 5.2</a>):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[83]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># favoured model has highest likelihood</span>
<span class="n">max_prob_BTS_BB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">ln_proba</span><span class="p">)</span>
<span class="n">idx_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span><span class="n">ln_proba</span><span class="p">),</span><span class="n">shape</span><span class="o">=</span><span class="n">ln_proba</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">bf_params_BTS_BB</span> <span class="o">=</span> <span class="n">final_chain</span><span class="p">[</span><span class="n">idx_max</span><span class="p">]</span>
<span class="n">bf_params_BTS_BB</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[83]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([3.11453061e+03, 4.05664843e+00, 4.75798199e-01, 8.81629368e-01,
       1.72113831e+03, 7.73025998e-01])
</pre></div></div>
</div>
</div>
<div class="section" id="4.5.-BT-SETTL-model-+-BrG-line-model">
<h2>4.5. BT-SETTL model + BrG line model<a class="headerlink" href="#4.5.-BT-SETTL-model-+-BrG-line-model" title="Permalink to this headline"></a></h2>
<p>In order to further showcase the possibilities available in <code class="docutils literal notranslate"><span class="pre">specfit</span></code>, let’s now consider a BT-SETTL + Brackett Gamma line model for the spectrum. Let’s also consider <span class="math notranslate nohighlight">\(R_V\)</span> as a free parameter, and finally consider Gaussian priors for log(<span class="math notranslate nohighlight">\(g\)</span>) and <span class="math notranslate nohighlight">\(R_V\)</span>: <span class="math notranslate nohighlight">\(\mu_{\mathrm{log}(g)}=3.5\)</span>, <span class="math notranslate nohighlight">\(\sigma_{\mathrm{log}(g)} = 0.2\)</span> and <span class="math notranslate nohighlight">\(\mu_{R_V}=3.1\)</span>, <span class="math notranslate nohighlight">\(\sigma_{R_V} = 0.2\)</span>.</p>
<p>This time, we have a total of 6 free parameters, including 2 captured by the BT-SETTL grid:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[84]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Teff&#39;</span><span class="p">,</span> <span class="s1">&#39;logg&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;Av&#39;</span><span class="p">,</span> <span class="s1">&#39;Rv&#39;</span><span class="p">,</span> <span class="s1">&#39;BrG&#39;</span><span class="p">)</span>
<span class="n">units</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$R_J$&#39;</span><span class="p">,</span> <span class="s1">&#39;mag&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
<span class="n">npar</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

<span class="n">teff_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">4000</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">21</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">logg_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span><span class="mf">5.5</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">grid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">teff_list</span><span class="p">,</span> <span class="n">logg_list</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>Provide estimate for BrG flux:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[85]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">astropy.constants</span> <span class="k">as</span> <span class="nn">con</span>
<span class="n">F_BrG_estimate</span> <span class="o">=</span> <span class="mi">20000</span> <span class="c1"># W m-2 at the surface (based on the estimate for the primary)</span>
<span class="n">RB_est</span> <span class="o">=</span> <span class="mi">5</span>             <span class="c1"># rough estimate for the radius of the companion in R_J</span>
<span class="n">input_unit</span> <span class="o">=</span> <span class="s1">&#39;LogL&#39;</span>    <span class="c1"># select input units {&#39;F&#39;,&#39;L&#39;,&#39;LogL&#39;} for Flux (W/m2), Luminosity (W) or Log Solar Luminosity.</span>
</pre></div>
</div>
</div>
<p>Conversion of F_BrG into LSun - do not change:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[86]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">input_unit</span> <span class="o">==</span> <span class="s1">&#39;F&#39;</span><span class="p">:</span>
    <span class="n">BrG_min</span> <span class="o">=</span> <span class="n">F_BrG_estimate</span><span class="o">*</span><span class="mf">1e-5</span>
    <span class="n">BrG_max</span> <span class="o">=</span> <span class="n">F_BrG_estimate</span><span class="o">*</span><span class="mf">1e5</span>
<span class="k">elif</span> <span class="n">input_unit</span> <span class="o">==</span> <span class="s1">&#39;LogL&#39;</span><span class="p">:</span>
    <span class="c1"># BrG flux is converted below into L_Sun</span>
    <span class="n">L_BrG_estimate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">con</span><span class="o">.</span><span class="n">R_jup</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">RB_est</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">F_BrG_estimate</span><span class="o">/</span><span class="n">con</span><span class="o">.</span><span class="n">L_sun</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    <span class="c1"># set min and max of BrG list of initial grid of tested values</span>
    <span class="n">BrG_min</span> <span class="o">=</span> <span class="n">L_BrG_estimate</span><span class="o">-</span><span class="mi">5</span>
    <span class="n">BrG_max</span> <span class="o">=</span> <span class="n">L_BrG_estimate</span><span class="o">+</span><span class="mi">5</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">BrG_min</span> <span class="o">=</span> <span class="n">F_BrG_estimate</span><span class="o">*</span><span class="mf">1e-5</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">con</span><span class="o">.</span><span class="n">R_jup</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">RB_est</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">BrG_max</span> <span class="o">=</span> <span class="n">F_BrG_estimate</span><span class="o">*</span><span class="mf">1e5</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">con</span><span class="o">.</span><span class="n">R_jup</span><span class="o">.</span><span class="n">value</span><span class="o">*</span><span class="n">RB_est</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Set the initial guesses and bounds accordingly. Note the requirement for a Jovian input radius.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[87]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># define list of BrG line luminosities</span>
<span class="n">n_BrG_list</span> <span class="o">=</span> <span class="mi">23</span> <span class="c1"># desired number of points in grid</span>
<span class="n">BrG_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">L_BrG_estimate</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="n">L_BrG_estimate</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_BrG_list</span><span class="p">)</span>
<span class="c1"># during MCMC, sampled values will be interpolated from the grid defined above for faster calculation.</span>

<span class="n">ini_guess</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3100.</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">,</span> <span class="mf">3.1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">BrG_list</span><span class="p">))</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Teff&#39;</span><span class="p">:(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">4000</span><span class="p">),</span>
          <span class="s1">&#39;logg&#39;</span><span class="p">:(</span><span class="mf">2.5</span><span class="p">,</span><span class="mf">5.5</span><span class="p">),</span>
          <span class="s1">&#39;R&#39;</span><span class="p">:(</span><span class="mf">0.1</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
          <span class="s1">&#39;Av&#39;</span><span class="p">:(</span><span class="mf">0.</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
          <span class="s1">&#39;Rv&#39;</span><span class="p">:(</span><span class="mf">1.</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
          <span class="s1">&#39;BrG&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">L_BrG_estimate</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="n">L_BrG_estimate</span><span class="o">+</span><span class="mi">5</span><span class="p">)}</span>
</pre></div>
</div>
</div>
<p>Provide details for each of the line(s). Add an entry in the <code class="docutils literal notranslate"><span class="pre">em_lines</span></code> and <code class="docutils literal notranslate"><span class="pre">em_grid</span></code> dictionaries for each line you’d like to include in the model. Lines can be included in the model without necessarily fitting for their flux with MCMC (e.g. for a known emission line luminosity to be included in the model):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[88]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">em_lines</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">em_lines</span><span class="p">[</span><span class="s1">&#39;BrG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.1667</span><span class="p">,</span> <span class="n">input_unit</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="c1"># WL, unit and flux (if known). Flux can be None if to be sampled by MCMC.</span>

<span class="n">em_grid</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">em_grid</span><span class="p">[</span><span class="s1">&#39;BrG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BrG_list</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Let’s set Gaussian priors for <span class="math notranslate nohighlight">\(R_V\)</span> in a dictionary. By default, uniform priors are considered for parameters not mentioned in this dictionary. Be sure to use the same dictionary labels as for parameter <code class="docutils literal notranslate"><span class="pre">labels</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[89]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">priors</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;logg&#39;</span><span class="p">:(</span><span class="mf">3.5</span><span class="p">,</span><span class="mf">0.2</span><span class="p">),</span>
          <span class="s1">&#39;Rv&#39;</span><span class="p">:(</span><span class="mf">3.1</span><span class="p">,</span><span class="mf">0.2</span><span class="p">)}</span>
</pre></div>
</div>
</div>
<p>Let’s compile all model-related parameters defined above into a dictionary:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[90]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;grid_param_list&#39;</span><span class="p">:</span><span class="n">grid_list</span><span class="p">,</span>
              <span class="s1">&#39;model_reader&#39;</span><span class="p">:</span><span class="n">bts_reader</span><span class="p">,</span>
              <span class="s1">&#39;labels&#39;</span><span class="p">:</span><span class="n">labels</span><span class="p">,</span>
              <span class="s1">&#39;initial_state&#39;</span><span class="p">:</span><span class="n">ini_guess</span><span class="p">,</span>
              <span class="s1">&#39;bounds&#39;</span><span class="p">:</span><span class="n">bounds</span><span class="p">,</span>
              <span class="s1">&#39;em_lines&#39;</span><span class="p">:</span><span class="n">em_lines</span><span class="p">,</span>
              <span class="s1">&#39;em_grid&#39;</span><span class="p">:</span><span class="n">em_grid</span><span class="p">,</span>
              <span class="s1">&#39;priors&#39;</span><span class="p">:</span><span class="n">priors</span><span class="p">,</span>
              <span class="s1">&#39;units_mod&#39;</span><span class="p">:</span><span class="n">units_mod</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>In order for the MCMC sampler to run faster, all models of the grid are first resampled (at the same sampling as the measured spectrum), such that only light spectra files are opened and interpolated during the sampling. To do so, set <code class="docutils literal notranslate"><span class="pre">resamp_before=True</span></code> and provide a path and name where the resampled grid will be saved:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[91]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid_name</span><span class="o">=</span><span class="s1">&#39;bts_BrG_resamp_grid.fits&#39;</span>
<span class="n">output_dir</span><span class="o">=</span><span class="s1">&#39;../static/bts_output/&#39;</span>
<span class="n">resamp_before</span><span class="o">=</span><span class="kc">True</span>
</pre></div>
</div>
</div>
<p><strong>Important</strong>: if a file named <code class="docutils literal notranslate"><span class="pre">output_dir</span></code>+<code class="docutils literal notranslate"><span class="pre">grid_name</span></code> already exists it will be used, instead of creating a new resmpled grid (this is to save time when a given MCMC sampling is performed multiple times with different options). Make sure to change either <code class="docutils literal notranslate"><span class="pre">output_dir</span></code> or <code class="docutils literal notranslate"><span class="pre">grid_name</span></code> when considering different models or a different range of parameter values in the grid (i.e. different <code class="docutils literal notranslate"><span class="pre">grid_list</span></code>).</p>
<p>We also set a filename where the MCMC results will be written as a pickle, such that they can be accessed without having to run again the MCMC.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[92]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">output_file</span> <span class="o">=</span> <span class="s1">&#39;MCMC_results_BrG&#39;</span> <span class="c1"># also written in output_dir</span>

<span class="n">output_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;resamp_before&#39;</span><span class="p">:</span><span class="n">resamp_before</span><span class="p">,</span>
                 <span class="s1">&#39;grid_name&#39;</span><span class="p">:</span><span class="n">grid_name</span><span class="p">,</span>
                 <span class="s1">&#39;output_dir&#39;</span><span class="p">:</span> <span class="n">output_dir</span><span class="p">,</span>
                 <span class="s1">&#39;output_file&#39;</span><span class="p">:</span> <span class="n">output_file</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>Finally, given the larger number of parameters, let’s increase the number of iterations and walkers:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[93]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">=</span><span class="mf">2.0</span>
<span class="n">nwalkers</span><span class="o">=</span><span class="mi">250</span>
<span class="n">niteration_min</span><span class="o">=</span><span class="mi">100</span>
<span class="n">niteration_limit</span><span class="o">=</span><span class="mi">1500</span> <span class="c1"># recommended&gt;&gt; 1000</span>
<span class="n">nproc</span> <span class="o">=</span> <span class="mi">2</span>             <span class="c1"># number of CPUs</span>

<span class="n">mcmc_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="n">a</span><span class="p">,</span>
               <span class="s1">&#39;nwalkers&#39;</span><span class="p">:</span><span class="n">nwalkers</span><span class="p">,</span>
               <span class="s1">&#39;niteration_min&#39;</span><span class="p">:</span><span class="n">niteration_min</span><span class="p">,</span>
               <span class="s1">&#39;niteration_limit&#39;</span><span class="p">:</span><span class="n">niteration_limit</span><span class="p">,</span>
               <span class="s1">&#39;nproc&#39;</span><span class="p">:</span><span class="n">nproc</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>Now let’s run the MCMC sampler (<strong>Warning: the next cell may take a few minutes to complete</strong>):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[94]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.mcmc_sampling</span> <span class="kn">import</span> <span class="n">mcmc_spec_sampling</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">mcmc_spec_sampling</span><span class="p">(</span><span class="n">lbda</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">spec_err</span><span class="p">,</span> <span class="n">d_st</span><span class="p">,</span> <span class="n">dlbda_obs</span><span class="o">=</span><span class="n">dlbda</span><span class="p">,</span> <span class="o">**</span><span class="n">instru_params</span><span class="p">,</span>
                                      <span class="o">**</span><span class="n">mcmc_params</span><span class="p">,</span> <span class="o">**</span><span class="n">conv_params</span><span class="p">,</span> <span class="o">**</span><span class="n">model_params</span><span class="p">,</span> <span class="o">**</span><span class="n">output_params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Fits HDU-0 data successfully loaded. Data shape: (21, 7, 23, 42, 2)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[95]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">final_chain</span><span class="p">,</span> <span class="n">ln_proba</span> <span class="o">=</span> <span class="n">res</span>
<span class="k">if</span> <span class="n">star</span><span class="p">:</span>
    <span class="n">idx_R</span> <span class="o">=</span> <span class="n">labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;R&#39;</span><span class="p">)</span>
    <span class="n">final_chain</span><span class="p">[:,:,</span><span class="n">idx_R</span><span class="p">]</span> <span class="o">=</span> <span class="n">final_chain</span><span class="p">[:,:,</span><span class="n">idx_R</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">conv_RS</span>
    <span class="c1"># change units of radius</span>
    <span class="n">units</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
    <span class="n">units</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$R_{\odot}$&#39;</span>
    <span class="n">units</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">units</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let’s inspect the walk plot:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[96]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.mcmc_sampling</span> <span class="kn">import</span> <span class="n">show_walk_plot</span>

<span class="n">show_walk_plot</span><span class="p">(</span><span class="n">final_chain</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span><span class="c1">#, save=False,# output_dir=&#39;../datasets/&#39;,</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_223_0.png" src="../_images/tutorials_walkthrough_223_0.png" />
</div>
</div>
<p>If you wish to save the walk plot in a pdf, set <code class="docutils literal notranslate"><span class="pre">save=True</span></code> and provide a value for the output directory (<code class="docutils literal notranslate"><span class="pre">output_dir</span></code>).</p>
<p>Based on the walk plot, let’s define a conservative burnin factor of 0.5 and apply it to the chain:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[97]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">burnin</span><span class="o">=</span><span class="mf">0.5</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[98]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cutoff</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">final_chain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">burnin</span><span class="p">))</span>
<span class="n">ngood_steps</span> <span class="o">=</span> <span class="n">final_chain</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">cutoff</span>
<span class="n">samples_flat_BrG</span> <span class="o">=</span> <span class="n">final_chain</span><span class="p">[:,</span> <span class="n">cutoff</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">npar</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>Let’s compute the 68.27% confidence intervals on the posterior distribution, after burnin:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[99]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.mcmc_sampling</span> <span class="kn">import</span> <span class="n">confidence</span>

<span class="n">bins</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">vals</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">confidence</span><span class="p">(</span><span class="n">samples_flat_BrG</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">cfd</span><span class="o">=</span><span class="mf">68.27</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">gaussian_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">priors</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
percentage for Teff: 69.07466666666667%
percentage for logg: 69.96746666666665%
percentage for R: 68.3392%
percentage for Av: 69.32853333333333%
percentage for Rv: 68.27413333333332%
percentage for BrG: 71.41173333333333%
******* Results for Teff *****


Confidence intervals:
Teff: 3142.0414314106793 [-30.816561161645495,43.79195533496977]
******* Results for logg *****


Confidence intervals:
logg: 4.245812133527229 [-0.12468995140380024,0.14464034362840916]
******* Results for R *****


Confidence intervals:
R: 0.5443511102674519 [-0.012393643347779149,0.010410660412134565]
******* Results for Av *****


Confidence intervals:
Av: 1.6498712509626843 [-0.10632183062218425,0.08080459127285988]
******* Results for Rv *****


Confidence intervals:
Rv: 3.063485624652843 [-0.1934371141778275,0.2270783514261452]
******* Results for BrG *****


Confidence intervals:
BrG: -5.590376640061844 [-0.07761023516494348,0.056914172454291645]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_229_1.png" src="../_images/tutorials_walkthrough_229_1.png" />
</div>
</div>
<p>If you wish to save the results in a text file, set <code class="docutils literal notranslate"><span class="pre">save=True</span></code> and provide a value for the output directory (<code class="docutils literal notranslate"><span class="pre">output_dir</span></code>).</p>
<p>Let’s define the most likely parameters along with their uncertainties in a numpy array:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[100]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">post_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">npar</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npar</span><span class="p">):</span>
    <span class="n">post_params</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
    <span class="n">post_params</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">err</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">post_params</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">err</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>Now, let’s have a look at the corner plot. A couple of parameters can be fine tuned for aesthetics, e.g.:</p>
<ul class="simple">
<li><p>number of significant digits for each parameter (<code class="docutils literal notranslate"><span class="pre">ndig</span></code>),</p></li>
<li><p>labels to be used in the plot for each parameter (<code class="docutils literal notranslate"><span class="pre">labels_plot</span></code> can be different to the string used in <code class="docutils literal notranslate"><span class="pre">labels</span></code> but <code class="docutils literal notranslate"><span class="pre">labels</span></code> is used if not provided),</p></li>
<li><p>font attributes for plot title and label,</p></li>
<li><p>number of bins to consider for the corner plot histograms.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[101]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ndig</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># should have same length as labels</span>
<span class="n">labels_plot</span> <span class="o">=</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$T$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;log($g$)&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$R$&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;$A_V$&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;$R_V$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$\log(\frac{L_{\rm BrG}}{L_{\odot}})$&quot;</span><span class="p">)</span>
<span class="n">title_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fontsize&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">}</span>
<span class="n">label_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;fontsize&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">}</span>
<span class="n">corner_bins</span> <span class="o">=</span> <span class="mi">20</span>
</pre></div>
</div>
</div>
<p>If you wish to save the corner plot in pdf format, set <code class="docutils literal notranslate"><span class="pre">save=True</span></code> and provide a value to <code class="docutils literal notranslate"><span class="pre">plot_name</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[102]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.mcmc_sampling</span> <span class="kn">import</span> <span class="n">show_corner_plot</span>

<span class="c1">#note: provide the chain before burnin, since burnin is done internally here:</span>
<span class="n">show_corner_plot</span><span class="p">(</span><span class="n">final_chain</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="n">burnin</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">mcmc_res</span><span class="o">=</span><span class="n">post_params</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">ndig</span><span class="o">=</span><span class="n">ndig</span><span class="p">,</span> <span class="n">labels_plot</span><span class="o">=</span><span class="n">labels_plot</span><span class="p">,</span>
                      <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="c1">#plot_name=&#39;corner_plot.pdf&#39;,</span>
                      <span class="n">title_kwargs</span><span class="o">=</span><span class="n">title_kwargs</span><span class="p">,</span> <span class="n">label_kwargs</span><span class="o">=</span><span class="n">label_kwargs</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">corner_bins</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_236_0.png" src="../_images/tutorials_walkthrough_236_0.png" />
</div>
</div>
<p>Compared to the results obtained without the inclusion of a potential BrG line (affecting the K1 photometry of the point source), we now get a lower value of log(g), more consistent with a young object. Nonetheless, the required BrG line luminosity is significant. This would likely imply the presence of more H recombination lines - which may or may not be present near ~1.09 and ~1.22 <span class="math notranslate nohighlight">\(\mu\)</span>m (see below).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[103]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">lbda</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">lbda</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">spec</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">lbda</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">spec_err</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="n">dlbda</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span> <span class="s1">&#39;bo&#39;</span><span class="p">,</span>
             <span class="n">label</span> <span class="o">=</span> <span class="s1">&#39;SPHERE/IFS (YJH)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Flux (W/m$^2$)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[103]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f9e20b2fcd0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_238_1.png" src="../_images/tutorials_walkthrough_238_1.png" />
</div>
</div>
<p>Let’s save the likelihood and parameter values of the most likely model for later (<a class="reference external" href="#5.2.-Best-fit-models">Sec. 5.2</a>):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[104]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># favoured model has highest likelihood</span>
<span class="n">max_prob_BTS_BrG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">ln_proba</span><span class="p">)</span>
<span class="n">idx_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanargmax</span><span class="p">(</span><span class="n">ln_proba</span><span class="p">),</span><span class="n">shape</span><span class="o">=</span><span class="n">ln_proba</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">bf_params_BTS_BrG</span> <span class="o">=</span> <span class="n">final_chain</span><span class="p">[</span><span class="n">idx_max</span><span class="p">]</span>
<span class="n">bf_params_BTS_BrG</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[104]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([ 3.14318793e+03,  4.25003767e+00,  5.44311050e-01,  1.63802590e+00,
        3.10729072e+00, -5.59085418e+00])
</pre></div></div>
</div>
<p><a class="reference external" href="#Table-of-contents">Go to the top</a></p>
</div>
</div>
<div class="section" id="5.-Comparison-of-results">
<h1>5. Comparison of results<a class="headerlink" href="#5.-Comparison-of-results" title="Permalink to this headline"></a></h1>
<div class="section" id="5.1.-Akaike-Information-Criterion">
<h2>5.1. Akaike Information Criterion<a class="headerlink" href="#5.1.-Akaike-Information-Criterion" title="Permalink to this headline"></a></h2>
<p>For each of the tested type of model above (Secs. 4.2 to 4.5), let’s compute the Akaike Information Criterion (AIC) in order to assess which one is likely the best model for our observations. The 4 tested models are:</p>
<ul class="simple">
<li><p>Blackbody (2 parameters);</p></li>
<li><p>BT-SETTL + extinction (4 parameters);</p></li>
<li><p>BT-SETTL + 2BB + extinction (8 parameters);</p></li>
<li><p>BT-SETTL + BrG + extinction (6 parameters)</p></li>
</ul>
<p>For each type of model, we need the maximum likelihood model among all MCMC samples, and the number of free parameters.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[105]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nparam_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
<span class="n">max_prob_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">max_prob_BB</span><span class="p">,</span> <span class="n">max_prob_BTS</span><span class="p">,</span> <span class="n">max_prob_BTS_BB</span><span class="p">,</span> <span class="n">max_prob_BTS_BrG</span><span class="p">]</span>

<span class="n">n_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nparam_list</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[106]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.utils_spec</span> <span class="kn">import</span> <span class="n">akaike</span>

<span class="n">aic_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">akaike</span><span class="p">(</span><span class="n">max_prob_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">nparam_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_models</span><span class="p">)]</span>
<span class="n">aic_list</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[106]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[269.38789884405725,
 139.56302978916275,
 132.59107553938156,
 145.31998428578405]
</pre></div></div>
</div>
<p>Now let’s compute the <span class="math notranslate nohighlight">\(\Delta\)</span> AIC, i.e. the difference with the smallest AIC value obtained for the different models:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[107]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">min_aic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">aic_list</span><span class="p">)</span>

<span class="n">daic_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">aic_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">min_aic</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_models</span><span class="p">)]</span>
<span class="n">daic_list</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[107]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[136.79682330467568, 6.9719542497811915, 0.0, 12.728908746402482]
</pre></div></div>
</div>
<p>The values above suggest that the most likely types of model that we considered are the BT-SETTL alone, the BT-SETTL+BB and BT-SETTL+BrG line models.</p>
<p>Since the difference is &gt;&gt;10 for the BB model, we can conclude that there is no support for that kind of model (Burnham &amp; Anderson 2002).</p>
<p><a class="reference external" href="#Table-of-contents">Go to the top</a></p>
</div>
<div class="section" id="5.2.-Best-fit-models">
<h2>5.2. Best-fit models<a class="headerlink" href="#5.2.-Best-fit-models" title="Permalink to this headline"></a></h2>
<p>Let’s first assemble all the relevant parameters from the different models considered above in different lists:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[108]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lab_models</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;BB&#39;</span><span class="p">,</span> <span class="s1">&#39;BT-SETTL&#39;</span><span class="p">,</span> <span class="s1">&#39;BT-SETTL + BB&#39;</span><span class="p">,</span> <span class="s1">&#39;BT-SETTL + BrG line&#39;</span><span class="p">]</span>
<span class="n">bf_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">bf_params_BB</span><span class="p">,</span> <span class="n">bf_params_BTS</span><span class="p">,</span> <span class="n">bf_params_BTS_BB</span><span class="p">,</span> <span class="n">bf_params_BTS_BrG</span><span class="p">]</span>
<span class="n">all_samples_flat</span> <span class="o">=</span> <span class="p">[</span><span class="n">samples_flat_BB</span><span class="p">,</span> <span class="n">samples_flat_BTS</span><span class="p">,</span> <span class="n">samples_flat_BTS_BB</span><span class="p">,</span> <span class="n">samples_flat_BrG</span><span class="p">]</span>
<span class="n">all_labels</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;Tbb1&#39;</span><span class="p">,</span> <span class="s1">&#39;Rbb1&#39;</span><span class="p">),</span>
              <span class="p">(</span><span class="s1">&#39;Teff&#39;</span><span class="p">,</span> <span class="s1">&#39;logg&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;Av&#39;</span><span class="p">),</span>
              <span class="p">(</span><span class="s1">&#39;Teff&#39;</span><span class="p">,</span> <span class="s1">&#39;logg&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;Av&#39;</span><span class="p">,</span> <span class="s1">&#39;Tbb1&#39;</span><span class="p">,</span> <span class="s1">&#39;Rbb1&#39;</span><span class="p">),</span>
              <span class="p">(</span><span class="s1">&#39;Teff&#39;</span><span class="p">,</span> <span class="s1">&#39;logg&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;Av&#39;</span><span class="p">,</span> <span class="s1">&#39;Rv&#39;</span><span class="p">,</span> <span class="s1">&#39;BrG&#39;</span><span class="p">)]</span>
<span class="n">all_grid_lists</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">grid_list</span><span class="p">,</span> <span class="n">grid_list</span><span class="p">,</span> <span class="n">grid_list</span><span class="p">]</span>
<span class="n">all_em_lines</span> <span class="o">=</span> <span class="p">[{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="n">em_lines</span><span class="p">]</span>
<span class="n">all_em_grids</span> <span class="o">=</span> <span class="p">[{},</span> <span class="p">{},</span> <span class="p">{},</span> <span class="n">em_grid</span><span class="p">]</span>
<span class="n">all_ndig</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
            <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)]</span>
<span class="n">all_units</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$R_J$&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$R_J$&#39;</span><span class="p">,</span> <span class="s1">&#39;mag&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$R_J$&#39;</span><span class="p">,</span> <span class="s1">&#39;mag&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$R_J$&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$R_J$&#39;</span><span class="p">,</span> <span class="s1">&#39;mag&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span>

<span class="n">n_models</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lab_models</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[109]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bf_params</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[109]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[array([2.58147810e+03, 7.39635865e-01]),
 array([3.16449482e+03, 5.00849672e+00, 5.61779329e-01, 1.80778235e+00]),
 array([3.11453061e+03, 4.05664843e+00, 4.75798199e-01, 8.81629368e-01,
        1.72113831e+03, 7.73025998e-01]),
 array([ 3.14318793e+03,  4.25003767e+00,  5.44311050e-01,  1.63802590e+00,
         3.10729072e+00, -5.59085418e+00])]
</pre></div></div>
</div>
<p>Now for each type of model considered above, let’s now generate the spectrum corresponding to the most likely parameters inferred with the MCMC. By providing <code class="docutils literal notranslate"><span class="pre">lbda_obs</span></code> to <code class="docutils literal notranslate"><span class="pre">make_model_from_params</span></code>, the returned model will be resampled to match the spectral resolution of the measured spectrum. If provided, the instrumental spectral FWHM and/or photometric filter(s) will also be used. If <code class="docutils literal notranslate"><span class="pre">lbda_obs</span></code> is left to None, the model is returned at the native resolution of the grid used as input.
Let’s leverage this to have both high-res and resampled spectra.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[110]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.model_resampling</span> <span class="kn">import</span> <span class="n">make_model_from_params</span>

<span class="n">bf_models</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">bf_models_hr</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_models</span><span class="p">):</span>
    <span class="n">bf_params_nn</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">bf_params</span><span class="p">[</span><span class="n">nn</span><span class="p">])</span>
    <span class="n">lbda_model</span><span class="p">,</span> <span class="n">flux_model</span> <span class="o">=</span> <span class="n">make_model_from_params</span><span class="p">(</span><span class="n">bf_params_nn</span><span class="p">,</span>
                                                    <span class="n">all_labels</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span>
                                                    <span class="n">all_grid_lists</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span>
                                                    <span class="n">d_st</span><span class="p">,</span>
                                                    <span class="n">model_reader</span><span class="o">=</span><span class="n">bts_reader</span><span class="p">,</span>
                                                    <span class="n">em_lines</span><span class="o">=</span><span class="n">all_em_lines</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span>
                                                    <span class="n">em_grid</span><span class="o">=</span><span class="n">all_em_grids</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span>
                                                    <span class="n">units_obs</span><span class="o">=</span><span class="n">units_obs</span><span class="p">,</span>
                                                    <span class="n">units_mod</span><span class="o">=</span><span class="n">units_mod</span><span class="p">,</span>
                                                    <span class="n">interp_order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                    <span class="n">lbda_obs</span><span class="o">=</span><span class="n">lbda</span><span class="p">,</span>
                                                    <span class="n">dlbda_obs</span><span class="o">=</span><span class="n">dlbda</span><span class="p">,</span>
                                                    <span class="n">instru_fwhm</span><span class="o">=</span><span class="n">instru_fwhm</span><span class="p">,</span>
                                                    <span class="n">instru_idx</span><span class="o">=</span><span class="n">instru_idx</span><span class="p">,</span>
                                                    <span class="n">filter_reader</span><span class="o">=</span><span class="n">filter_reader</span><span class="p">)</span>
    <span class="n">bf_models</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">lbda_model</span><span class="p">,</span> <span class="n">flux_model</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">nn</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">lbda_model_hr</span><span class="p">,</span> <span class="n">flux_model_hr</span> <span class="o">=</span> <span class="n">make_model_from_params</span><span class="p">(</span><span class="n">bf_params_nn</span><span class="p">,</span>
                                                              <span class="n">all_labels</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span>
                                                              <span class="n">all_grid_lists</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span>
                                                              <span class="n">d_st</span><span class="p">,</span>
                                                              <span class="n">model_reader</span><span class="o">=</span><span class="n">bts_reader</span><span class="p">,</span>
                                                              <span class="n">em_lines</span><span class="o">=</span><span class="n">all_em_lines</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span>
                                                              <span class="n">em_grid</span><span class="o">=</span><span class="n">all_em_grids</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span>
                                                              <span class="n">units_obs</span><span class="o">=</span><span class="n">units_obs</span><span class="p">,</span>
                                                              <span class="n">units_mod</span><span class="o">=</span><span class="n">units_mod</span><span class="p">,</span>
                                                              <span class="n">interp_order</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">bf_models_hr</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">lbda_model_hr</span><span class="p">,</span> <span class="n">flux_model_hr</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>For models not based on a grid, <code class="docutils literal notranslate"><span class="pre">lbda_obs</span></code> is a mandatory parameter, hence the avoidance of the BB model for high-res models. Let’s use the output <code class="docutils literal notranslate"><span class="pre">lbda_model_hr</span></code> from BT-SETTL models, to add a high-res spectrum for the BB model as well.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[111]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lbda_model_hr</span><span class="p">,</span> <span class="n">flux_model_hr</span> <span class="o">=</span> <span class="n">make_model_from_params</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">bf_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                                      <span class="n">all_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                      <span class="n">all_grid_lists</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                      <span class="n">d_st</span><span class="p">,</span>
                                                      <span class="n">model_reader</span><span class="o">=</span><span class="n">bts_reader</span><span class="p">,</span>
                                                      <span class="n">em_lines</span><span class="o">=</span><span class="n">all_em_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                      <span class="n">em_grid</span><span class="o">=</span><span class="n">all_em_grids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                      <span class="n">units_obs</span><span class="o">=</span><span class="n">units_obs</span><span class="p">,</span>
                                                      <span class="n">units_mod</span><span class="o">=</span><span class="n">units_mod</span><span class="p">,</span>
                                                      <span class="n">interp_order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                      <span class="n">lbda_obs</span><span class="o">=</span><span class="n">bf_models_hr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">bf_models_hr</span> <span class="o">=</span> <span class="p">[[</span><span class="n">lbda_model_hr</span><span class="p">,</span> <span class="n">flux_model_hr</span><span class="p">]]</span><span class="o">+</span><span class="n">bf_models_hr</span>
</pre></div>
</div>
</div>
<p>Now crop the model spectra to the same wavelength range as the measured spectrum:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[112]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.utils_spec</span> <span class="kn">import</span> <span class="n">find_nearest</span>

<span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_models</span><span class="p">):</span>
    <span class="n">lbda_model_hr</span><span class="p">,</span> <span class="n">flux_model_hr</span> <span class="o">=</span> <span class="n">bf_models_hr</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span>
    <span class="c1"># LOAD BEST FIT MODEL</span>
    <span class="n">idx_ini</span> <span class="o">=</span> <span class="n">find_nearest</span><span class="p">(</span><span class="n">lbda_model_hr</span><span class="p">,</span><span class="mf">0.99</span><span class="o">*</span><span class="n">lbda</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">constraint</span><span class="o">=</span><span class="s1">&#39;floor&#39;</span><span class="p">)</span>
    <span class="n">idx_fin</span> <span class="o">=</span> <span class="n">find_nearest</span><span class="p">(</span><span class="n">lbda_model_hr</span><span class="p">,</span><span class="mf">1.01</span><span class="o">*</span><span class="n">lbda</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">constraint</span><span class="o">=</span><span class="s1">&#39;ceil&#39;</span><span class="p">)</span>
    <span class="n">lbda_model_hr</span> <span class="o">=</span> <span class="n">lbda_model_hr</span><span class="p">[</span><span class="n">idx_ini</span><span class="p">:</span><span class="n">idx_fin</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">flux_model_hr</span> <span class="o">=</span> <span class="n">flux_model_hr</span><span class="p">[</span><span class="n">idx_ini</span><span class="p">:</span><span class="n">idx_fin</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dlbda_hr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lbda_model_hr</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">lbda_model_hr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">bf_models_hr</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">lbda_model_hr</span><span class="p">,</span> <span class="n">flux_model_hr</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>Now let’s plot the best-fit models at their native resolution (first panel) and after resampling (second panel):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[113]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>

<span class="c1"># plot options</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="c1"># colors of different models</span>
<span class="n">maj_tick_sp</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># WL spacing for major ticks</span>
<span class="n">min_tick_sp</span> <span class="o">=</span> <span class="n">maj_tick_sp</span> <span class="o">/</span> <span class="mf">5.</span> <span class="c1"># WL spacing for minor ticks</span>

<span class="c1"># Titles</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Best-fit models (original resolution)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Best-fit models (resampled)&quot;</span><span class="p">)</span>

<span class="c1"># Plot measured spectrum</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">lbda</span><span class="p">,</span> <span class="n">lbda</span><span class="o">*</span><span class="n">spec</span><span class="p">,</span>
             <span class="n">lbda</span><span class="o">*</span><span class="n">spec_err</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Measured spectrum&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">lbda</span><span class="p">,</span> <span class="n">lbda</span><span class="o">*</span><span class="n">spec</span><span class="p">,</span>
             <span class="n">lbda</span><span class="o">*</span><span class="n">spec_err</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Measured spectrum&#39;</span><span class="p">)</span>

<span class="c1"># Set axes labels</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\lambda F_{\lambda}$ (W m$^{-2} \mu$m$^{-1}$)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\lambda F_{\lambda}$ (W m$^{-2} \mu$m$^{-1}$)&quot;</span><span class="p">)</span>

<span class="c1"># Plot best-fit models</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">bf_models_i</span> <span class="o">=</span> <span class="n">bf_models_hr</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">bf_models_i</span> <span class="o">=</span> <span class="n">bf_models</span>
    <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_models</span><span class="p">):</span>
        <span class="n">lbda_model</span><span class="p">,</span> <span class="n">flux_model</span> <span class="o">=</span> <span class="n">bf_models_i</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span>

        <span class="n">lab_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> = {1:.</span><span class="si">{2}</span><span class="s1">f} </span><span class="si">{3}</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="n">nn</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">nn</span> <span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">show_labs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bf_params</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">nn</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">show_labs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bf_params</span><span class="p">[</span><span class="n">nn</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">show_labs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bf_params</span><span class="p">[</span><span class="n">nn</span><span class="p">])</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">lab_str_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">lab_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">all_labels</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">bf_params</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">all_ndig</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">all_units</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">show_labs</span><span class="p">]</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> model: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lab_models</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span> <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lab_str_list</span><span class="p">))</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lbda_model</span><span class="p">,</span> <span class="n">lbda_model</span><span class="o">*</span><span class="n">flux_model</span><span class="p">,</span> <span class="n">cols</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">nn</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                 <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

        <span class="n">min_tick</span> <span class="o">=</span> <span class="n">lbda</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dlbda</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="p">((</span><span class="n">lbda</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dlbda</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">%</span><span class="k">0</span>.2)
        <span class="n">max_tick</span> <span class="o">=</span> <span class="n">lbda</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dlbda</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="mf">0.2</span><span class="o">-</span><span class="p">((</span><span class="n">lbda</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dlbda</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">%</span><span class="k">0</span>.2))
        <span class="n">major_ticks1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_tick</span><span class="p">,</span><span class="n">max_tick</span><span class="p">,</span><span class="n">maj_tick_sp</span><span class="p">)</span>
        <span class="n">minor_ticks1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_tick</span><span class="p">,</span><span class="n">max_tick</span><span class="p">,</span><span class="n">min_tick_sp</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">major_ticks1</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">minor_ticks1</span><span class="p">,</span> <span class="n">minor</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span> <span class="o">=</span> <span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;in&#39;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_263_0.png" src="../_images/tutorials_walkthrough_263_0.png" />
</div>
</div>
<p><a class="reference external" href="#Table-of-contents">Go to the top</a></p>
</div>
<div class="section" id="5.3.-Models-from-the-posterior-distribution">
<h2>5.3. Models from the posterior distribution<a class="headerlink" href="#5.3.-Models-from-the-posterior-distribution" title="Permalink to this headline"></a></h2>
<p>It can be useful to plot a large number of models randomly picked from the posterior distribution in order to have an idea of the uncertainty in different parts of the spectrum. Let’s consider 200 samples from the posterior distribution:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[114]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_samp</span> <span class="o">=</span> <span class="mi">200</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[115]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>

<span class="n">all_plot_samples</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_models</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;################## Model </span><span class="si">{}</span><span class="s2"> ##################&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lab_models</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
    <span class="n">samp_flux</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">lbda_samp</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># use native model resolution (set to `lbda` for measured spectrum sampling)</span>
    <span class="k">if</span> <span class="n">nn</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># set the wavelength sampling for</span>
        <span class="n">lbda_samp</span><span class="o">=</span><span class="n">bf_models_hr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samp</span><span class="p">):</span>
        <span class="c1"># draw a random integer</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_samples_flat</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
        <span class="n">param_samp</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">all_samples_flat</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>
        <span class="n">samp_lbda</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">make_model_from_params</span><span class="p">(</span><span class="n">param_samp</span><span class="p">,</span> <span class="n">all_labels</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span> <span class="n">all_grid_lists</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span> <span class="n">d_st</span><span class="p">,</span>
                                                <span class="n">model_reader</span><span class="o">=</span><span class="n">bts_reader</span><span class="p">,</span> <span class="n">em_lines</span><span class="o">=</span><span class="n">all_em_lines</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span>
                                                <span class="n">em_grid</span><span class="o">=</span><span class="n">all_em_grids</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span> <span class="n">units_obs</span><span class="o">=</span><span class="n">units_obs</span><span class="p">,</span>
                                                <span class="n">units_mod</span><span class="o">=</span><span class="n">units_mod</span><span class="p">,</span> <span class="n">interp_order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">lbda_obs</span><span class="o">=</span><span class="n">lbda_samp</span><span class="p">)</span>

        <span class="n">samp_flux</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
    <span class="c1"># Crop to same range as measurements</span>
    <span class="n">idx_ini</span> <span class="o">=</span> <span class="n">find_nearest</span><span class="p">(</span><span class="n">samp_lbda</span><span class="p">,</span><span class="mf">0.99</span><span class="o">*</span><span class="n">lbda</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">constraint</span><span class="o">=</span><span class="s1">&#39;floor&#39;</span><span class="p">)</span>
    <span class="n">idx_fin</span> <span class="o">=</span> <span class="n">find_nearest</span><span class="p">(</span><span class="n">samp_lbda</span><span class="p">,</span><span class="mf">1.01</span><span class="o">*</span><span class="n">lbda</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">constraint</span><span class="o">=</span><span class="s1">&#39;ceil&#39;</span><span class="p">)</span>
    <span class="n">samp_lbda</span> <span class="o">=</span> <span class="n">samp_lbda</span><span class="p">[</span><span class="n">idx_ini</span><span class="p">:</span><span class="n">idx_fin</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">samp_fluxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">samp_flux</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="n">idx_ini</span><span class="p">:</span><span class="n">idx_fin</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samp</span><span class="p">)]</span>
    <span class="n">all_plot_samples</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">samp_lbda</span><span class="p">,</span><span class="n">samp_fluxes</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
################## Model BB ##################
################## Model BT-SETTL ##################
################## Model BT-SETTL + BB ##################
################## Model BT-SETTL + BrG line ##################
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/valentin/GitHub/special/special/model_resampling.py:250: RuntimeWarning: overflow encountered in power
  flux_ratio_ext = np.power(10.,-extinc_curve/2.5)
</pre></div></div>
</div>
<p>Now let’s plot the samples:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[116]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">24</span><span class="p">))</span>

<span class="c1"># plot options</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="c1"># colors of different models</span>
<span class="n">maj_tick_sp</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># WL spacing for major ticks</span>
<span class="n">min_tick_sp</span> <span class="o">=</span> <span class="n">maj_tick_sp</span> <span class="o">/</span> <span class="mf">5.</span> <span class="c1"># WL spacing for minor ticks</span>

<span class="c1"># Titles</span>
<span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_models</span><span class="p">):</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Sample models from posterior distribution (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lab_models</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>

    <span class="c1"># Set axes labels</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\lambda F_{\lambda}$ (W m$^{-2} \mu$m$^{-1}$)&quot;</span><span class="p">)</span>

    <span class="c1"># Options depending on model</span>
    <span class="k">if</span> <span class="n">nn</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">nn</span> <span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">show_labs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bf_params</span><span class="p">[</span><span class="n">nn</span><span class="p">]))</span>
    <span class="k">elif</span> <span class="n">nn</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">show_labs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bf_params</span><span class="p">[</span><span class="n">nn</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">show_labs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bf_params</span><span class="p">[</span><span class="n">nn</span><span class="p">])</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>

    <span class="c1"># Plot sample models</span>
    <span class="n">lbda_samp</span><span class="p">,</span> <span class="n">fluxes_model</span> <span class="o">=</span> <span class="n">all_plot_samples</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_samp</span><span class="p">):</span>
        <span class="n">flux_model</span> <span class="o">=</span> <span class="n">fluxes_model</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lab_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1"> = {1:.</span><span class="si">{2}</span><span class="s1">f} </span><span class="si">{3}</span><span class="s1">&#39;</span>
            <span class="n">lab_str_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">lab_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">all_labels</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">bf_params</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">all_ndig</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="n">j</span><span class="p">],</span> <span class="n">all_units</span><span class="p">[</span><span class="n">nn</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">show_labs</span><span class="p">]</span>
            <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> model samples&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lab_models</span><span class="p">[</span><span class="n">nn</span><span class="p">])</span><span class="c1">#: {}&quot;.format(lab_models[nn], sep.join(lab_str_list))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lbda_samp</span><span class="p">,</span> <span class="n">lbda_samp</span><span class="o">*</span><span class="n">flux_model</span><span class="p">,</span> <span class="n">cols</span><span class="p">[</span><span class="mi">1</span><span class="o">+</span><span class="n">nn</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

    <span class="n">min_tick</span> <span class="o">=</span> <span class="n">lbda</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dlbda</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="p">((</span><span class="n">lbda</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dlbda</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">%</span><span class="k">0</span>.2)
    <span class="n">max_tick</span> <span class="o">=</span> <span class="n">lbda</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dlbda</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="mf">0.2</span><span class="o">-</span><span class="p">((</span><span class="n">lbda</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dlbda</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">%</span><span class="k">0</span>.2))
    <span class="n">major_ticks1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_tick</span><span class="p">,</span><span class="n">max_tick</span><span class="p">,</span><span class="n">maj_tick_sp</span><span class="p">)</span>
    <span class="n">minor_ticks1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_tick</span><span class="p">,</span><span class="n">max_tick</span><span class="p">,</span><span class="n">min_tick_sp</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">major_ticks1</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">minor_ticks1</span><span class="p">,</span> <span class="n">minor</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span> <span class="o">=</span> <span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;in&#39;</span><span class="p">)</span>


    <span class="c1"># Plot measured spectrum</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">lbda</span><span class="p">,</span> <span class="n">lbda</span><span class="o">*</span><span class="n">spec</span><span class="p">,</span>
                     <span class="n">lbda</span><span class="o">*</span><span class="n">spec_err</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
                     <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Measured spectrum&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">nn</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_270_0.png" src="../_images/tutorials_walkthrough_270_0.png" />
</div>
</div>
<p><a class="reference external" href="#Table-of-contents">Go to the top</a></p>
</div>
</div>
<div class="section" id="6.-Nested-sampler-examples">
<h1>6. Nested sampler examples<a class="headerlink" href="#6.-Nested-sampler-examples" title="Permalink to this headline"></a></h1>
<p>The procedure is very similar to set the MCMC and the nested sampler routines as most parameters of <code class="docutils literal notranslate"><span class="pre">mcmc_spec_sampling</span></code> and <code class="docutils literal notranslate"><span class="pre">nested_spec_sampling</span></code> are identical.</p>
<p>The only differences are the <code class="docutils literal notranslate"><span class="pre">method</span></code>, <code class="docutils literal notranslate"><span class="pre">npoints</span></code>, <code class="docutils literal notranslate"><span class="pre">dlogz</span></code>, <code class="docutils literal notranslate"><span class="pre">decline_factor</span></code> and <code class="docutils literal notranslate"><span class="pre">rstate</span></code> parameters for the nested sampler. Most importantly the <code class="docutils literal notranslate"><span class="pre">method</span></code> can be set to <code class="docutils literal notranslate"><span class="pre">'classic'</span></code> (mcmc; Skilling 2004), <code class="docutils literal notranslate"><span class="pre">'single'</span></code> (single ellipsoid; Mutherjee et al. 2006) or <code class="docutils literal notranslate"><span class="pre">'multi'</span></code> (original multinest implementation as in Feroz et al. 2009, with conservative ellipsoid splitting).</p>
<p>The interested user is referred to the documentation of <a class="reference external" href="http://kylebarbary.com/nestle/">nestle</a> for details on how to appropriately set these parameters.</p>
<p>Below we just show the example for running the nested sampler with the BT-SETTL grid, considering A_V as a free parameter. Let’s first set the parameters as in <a class="reference external" href="#4.3.-BT-SETTL-model">Sec. 4.3</a>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[117]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">bts_reader</span>

<span class="n">teff_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">4000</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">21</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">logg_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span><span class="mf">5.5</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">grid_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">teff_list</span><span class="p">,</span> <span class="n">logg_list</span><span class="p">]</span>

<span class="n">ini_guess</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3100.</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">)</span>

<span class="n">labels</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Teff&#39;</span><span class="p">,</span> <span class="s1">&#39;logg&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;Av&#39;</span><span class="p">)</span>
<span class="n">labels_plot</span> <span class="o">=</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$T$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;log($g$)&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$R$&#39;</span><span class="p">,</span>  <span class="sa">r</span><span class="s1">&#39;$A_V$&#39;</span><span class="p">)</span>
<span class="n">units</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$R_J$&#39;</span><span class="p">,</span> <span class="s1">&#39;mag&#39;</span><span class="p">)</span>
<span class="n">ndig</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># number of significant digits</span>
<span class="n">units_mod</span> <span class="o">=</span> <span class="s1">&#39;si&#39;</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Teff&#39;</span><span class="p">:(</span><span class="mi">2000</span><span class="p">,</span><span class="mi">4000</span><span class="p">),</span>
          <span class="s1">&#39;logg&#39;</span><span class="p">:(</span><span class="mf">2.5</span><span class="p">,</span><span class="mf">5.5</span><span class="p">),</span>
          <span class="s1">&#39;R&#39;</span><span class="p">:(</span><span class="mf">0.1</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span>
          <span class="s1">&#39;Av&#39;</span><span class="p">:(</span><span class="mf">0.</span><span class="p">,</span><span class="mi">5</span><span class="p">)}</span>
<span class="n">model_params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;grid_param_list&#39;</span><span class="p">:</span><span class="n">grid_list</span><span class="p">,</span>
              <span class="s1">&#39;model_reader&#39;</span><span class="p">:</span><span class="n">bts_reader</span><span class="p">,</span>
              <span class="s1">&#39;labels&#39;</span><span class="p">:</span><span class="n">labels</span><span class="p">,</span>
              <span class="s1">&#39;bounds&#39;</span><span class="p">:</span><span class="n">bounds</span><span class="p">,</span>
              <span class="s1">&#39;units_mod&#39;</span><span class="p">:</span><span class="n">units_mod</span><span class="p">}</span>

<span class="n">grid_name</span><span class="o">=</span><span class="s1">&#39;bts_resamp_grid.fits&#39;</span>
<span class="n">output_dir</span><span class="o">=</span><span class="s1">&#39;../static/bts_output/&#39;</span>
<span class="n">resamp_before</span><span class="o">=</span><span class="kc">True</span>
<span class="n">output_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;resamp_before&#39;</span><span class="p">:</span><span class="n">resamp_before</span><span class="p">,</span>
                 <span class="s1">&#39;grid_name&#39;</span><span class="p">:</span><span class="n">grid_name</span><span class="p">,</span>
                 <span class="s1">&#39;output_dir&#39;</span><span class="p">:</span> <span class="n">output_dir</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="6.1.-Single-ellipsoid-method">
<h2>6.1. Single ellipsoid method<a class="headerlink" href="#6.1.-Single-ellipsoid-method" title="Permalink to this headline"></a></h2>
<p>Now let’s set the parameters that are specific to the nested sampler:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[118]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;single&#39;</span>
<span class="n">npoints</span><span class="o">=</span><span class="mi">150</span>
<span class="n">dlogz</span><span class="o">=</span><span class="mf">0.1</span>
<span class="n">decline_factor</span><span class="o">=</span><span class="kc">None</span>
<span class="n">rstate</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[119]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nestle_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span><span class="n">method</span><span class="p">,</span>
                 <span class="s1">&#39;npoints&#39;</span><span class="p">:</span><span class="n">npoints</span><span class="p">,</span>
                 <span class="s1">&#39;dlogz&#39;</span><span class="p">:</span><span class="n">dlogz</span><span class="p">,</span>
                 <span class="s1">&#39;decline_factor&#39;</span><span class="p">:</span><span class="n">decline_factor</span><span class="p">,</span>
                 <span class="s1">&#39;rstate&#39;</span><span class="p">:</span><span class="n">rstate</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>Now let’s run the nested sampler (<strong>Warning: the next cell may take up to a few minutes to complete</strong>):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[120]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.nested_sampling</span> <span class="kn">import</span> <span class="n">nested_spec_sampling</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">nested_spec_sampling</span><span class="p">(</span><span class="n">ini_guess</span><span class="p">,</span> <span class="n">lbda</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">spec_err</span><span class="p">,</span> <span class="n">d_st</span><span class="p">,</span> <span class="n">dlbda_obs</span><span class="o">=</span><span class="n">dlbda</span><span class="p">,</span> <span class="o">**</span><span class="n">instru_params</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">nestle_params</span><span class="p">,</span> <span class="o">**</span><span class="n">model_params</span><span class="p">,</span> <span class="o">**</span><span class="n">output_params</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Fits HDU-0 data successfully loaded. Data shape: (21, 7, 42, 2)
――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――
Starting time: 2022-02-24 00:06:38
――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――
Prior bounds on parameters:
Teff [2000,4000]
logg [2.5,5.5]
R [0.1,5]
Av [0.0,5]

Using 150 active points

Total running time:
Running time:  0:00:31.279935
――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――
</pre></div></div>
</div>
<p>Now let’s plot the results:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[121]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.nested_sampling</span> <span class="kn">import</span> <span class="n">nested_sampling_results</span>

<span class="n">final_res</span> <span class="o">=</span> <span class="n">nested_sampling_results</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cfd</span><span class="o">=</span><span class="mf">68.27</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span>
                                    <span class="n">ndig</span><span class="o">=</span><span class="n">ndig</span><span class="p">,</span> <span class="n">labels_plot</span><span class="o">=</span><span class="n">labels_plot</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">output_dir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
niter: 2595
ncall: 7503
nsamples: 2745
logz: -80.759 +/-  0.294
h: 12.956

Natural log of prior volume and Weight corresponding to each sample
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_282_1.png" src="../_images/tutorials_walkthrough_282_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Walk plots before the burnin
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_282_3.png" src="../_images/tutorials_walkthrough_282_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Walk plots after the burnin
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_282_5.png" src="../_images/tutorials_walkthrough_282_5.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Weighted mean +- sqrt(covariance)
Teff = 3166 +/- 37
logg = 5.0 +/- 0.2
R = 0.56 +/- 0.01
Av = 1.8 +/- 0.1

Hist bins = 28
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_282_7.png" src="../_images/tutorials_walkthrough_282_7.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Confidence intervals
percentage for Teff: 72.25102941021323%
percentage for logg: 70.80675188204253%
percentage for R: 72.21570245103074%
percentage for Av: 69.30442141313974%
******* Results for Teff *****


Confidence intervals:
Teff: 3158.9382114518676 [-37.31330939760937,50.88178554219439]
Gaussian fit results:
Teff: 3165.9259554667246 +-33.31403671739215
******* Results for logg *****


Confidence intervals:
logg: 4.997272363420294 [-0.20368475044161638,0.24071834143100101]
Gaussian fit results:
logg: 5.024117486245867 +-0.1821947892624436
******* Results for R *****


Confidence intervals:
R: 0.5600255209124116 [-0.010247379696598946,0.012110539641435158]
Gaussian fit results:
R: 0.5603280289451887 +-0.008239106295569421
******* Results for Av *****


Confidence intervals:
Av: 1.8170210849995598 [-0.09416329377611432,0.03138776459203818]
Gaussian fit results:
Av: 1.7931503195825318 +-0.056403123266996834
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_282_9.png" src="../_images/tutorials_walkthrough_282_9.png" />
</div>
</div>
<p>The best-fit parameters, with uncertainty are:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[122]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)):</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;{{:.</span><span class="si">{0}</span><span class="s2">f}}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ndig</span><span class="p">[</span><span class="n">p</span><span class="p">])</span><span class="o">.</span><span class="n">format</span>
    <span class="n">line</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="s2">+/-</span><span class="si">{2}</span><span class="s2"> </span><span class="si">{3}</span><span class="s2">&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">labels</span><span class="p">[</span><span class="n">p</span><span class="p">],</span><span class="n">fmt</span><span class="p">(</span><span class="n">final_res</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span><span class="n">fmt</span><span class="p">(</span><span class="n">final_res</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="n">units</span><span class="p">[</span><span class="n">p</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Teff: 3166+/-37 K
logg: 5.0+/-0.2
R: 0.56+/-0.01 $R_J$
Av: 1.8+/-0.1 mag
</pre></div></div>
</div>
</div>
<div class="section" id="6.2.-Multi-ellipsoid-method">
<h2>6.2. Multi-ellipsoid method<a class="headerlink" href="#6.2.-Multi-ellipsoid-method" title="Permalink to this headline"></a></h2>
<p>Let’s adapt the method and number of active points:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[123]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;multi&#39;</span>
<span class="n">npoints</span><span class="o">=</span><span class="mi">300</span>
<span class="n">dlogz</span><span class="o">=</span><span class="mf">0.5</span>
<span class="n">decline_factor</span><span class="o">=</span><span class="kc">None</span>
<span class="n">rstate</span><span class="o">=</span><span class="kc">None</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[124]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nestle_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;method&#39;</span><span class="p">:</span><span class="n">method</span><span class="p">,</span>
                 <span class="s1">&#39;npoints&#39;</span><span class="p">:</span><span class="n">npoints</span><span class="p">,</span>
                 <span class="s1">&#39;dlogz&#39;</span><span class="p">:</span><span class="n">dlogz</span><span class="p">,</span>
                 <span class="s1">&#39;decline_factor&#39;</span><span class="p">:</span><span class="n">decline_factor</span><span class="p">,</span>
                 <span class="s1">&#39;rstate&#39;</span><span class="p">:</span><span class="n">rstate</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>Now let’s run the nested sampler (<strong>Warning: the next cell may take up to a few minutes to complete</strong>):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[125]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.nested_sampling</span> <span class="kn">import</span> <span class="n">nested_spec_sampling</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">nested_spec_sampling</span><span class="p">(</span><span class="n">ini_guess</span><span class="p">,</span> <span class="n">lbda</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">spec_err</span><span class="p">,</span> <span class="n">d_st</span><span class="p">,</span> <span class="n">dlbda_obs</span><span class="o">=</span><span class="n">dlbda</span><span class="p">,</span> <span class="o">**</span><span class="n">instru_params</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">nestle_params</span><span class="p">,</span> <span class="o">**</span><span class="n">model_params</span><span class="p">,</span> <span class="o">**</span><span class="n">output_params</span><span class="p">)</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Fits HDU-0 data successfully loaded. Data shape: (21, 7, 42, 2)
――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――
Starting time: 2022-02-24 00:07:11
――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――
Prior bounds on parameters:
Teff [2000,4000]
logg [2.5,5.5]
R [0.1,5]
Av [0.0,5]

Using 300 active points

Total running time:
Running time:  0:00:58.404617
――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――
</pre></div></div>
</div>
<p>Now let’s plot the results:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[126]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.nested_sampling</span> <span class="kn">import</span> <span class="n">nested_sampling_results</span>

<span class="n">final_res</span> <span class="o">=</span> <span class="n">nested_sampling_results</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">burnin</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cfd</span><span class="o">=</span><span class="mf">68.27</span><span class="p">,</span>
                                    <span class="n">units</span><span class="o">=</span><span class="n">units</span><span class="p">,</span> <span class="n">ndig</span><span class="o">=</span><span class="n">ndig</span><span class="p">,</span> <span class="n">labels_plot</span><span class="o">=</span><span class="n">labels_plot</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">output_dir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
niter: 4688
ncall: 13572
nsamples: 4988
logz: -80.721 +/-  0.207
h: 12.898

Natural log of prior volume and Weight corresponding to each sample
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_292_1.png" src="../_images/tutorials_walkthrough_292_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Walk plots before the burnin
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_292_3.png" src="../_images/tutorials_walkthrough_292_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Walk plots after the burnin
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_292_5.png" src="../_images/tutorials_walkthrough_292_5.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Weighted mean +- sqrt(covariance)
Teff = 3167 +/- 42
logg = 5.0 +/- 0.2
R = 0.56 +/- 0.01
Av = 1.8 +/- 0.1

Hist bins = 38
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_292_7.png" src="../_images/tutorials_walkthrough_292_7.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Confidence intervals
percentage for Teff: 70.34423301587171%
percentage for logg: 71.0697909492108%
percentage for R: 68.4953107216636%
percentage for Av: 70.04788197560795%
******* Results for Teff *****


Confidence intervals:
Teff: 3176.2265092999996 [-54.2228121821031,32.53368730926195]
Gaussian fit results:
Teff: 3168.050967781139 +-48.25419785147604
******* Results for logg *****


Confidence intervals:
logg: 5.071391344562933 [-0.30020849685726514,0.17380491923315322]
Gaussian fit results:
logg: 4.995837099458828 +-0.23067233387611963
******* Results for R *****


Confidence intervals:
R: 0.5580633610377336 [-0.0069373593409435275,0.012883667347466599]
Gaussian fit results:
R: 0.5589083737270827 +-0.011683365181188708
******* Results for Av *****


Confidence intervals:
Av: 1.7956425718448945 [-0.0767826940391616,0.07678269403916183]
Gaussian fit results:
Av: 1.7867577840924127 +-0.07848244046150588
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_292_9.png" src="../_images/tutorials_walkthrough_292_9.png" />
</div>
</div>
<p>We see that for the case of the spectrum of CrA-9B/b with a BT-SETTL + extinction model, even when we allow for multiple nests, the highest likelihood area in the parameter space still corresponds to an individual ellipsoid.</p>
</div>
</div>
<div class="section" id="7.-Best-fit-template-spectrum">
<h1>7. Best-fit template spectrum<a class="headerlink" href="#7.-Best-fit-template-spectrum" title="Permalink to this headline"></a></h1>
<p>In this section, we will find the best-fit template spectra to our measured spectrum in the Montreal Spectral Library of observed M-L-T type low-mass objects. Since the template spectra from this library typically do not cover wavelengths longward of the K band, we will discard the NACO L’ point from the spectrum, just for the sake of this exercise:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[127]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lbda_crop</span> <span class="o">=</span> <span class="n">lbda</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">spec_crop</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">spec_err_crop</span> <span class="o">=</span> <span class="n">spec_err</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">dlbda_crop</span> <span class="o">=</span> <span class="n">dlbda</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>Let’s define the parameters associated to the instrument(s) which acquired the spectrum (again we discard the NACO measurement):</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[128]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">instru_fwhm_crop</span> <span class="o">=</span> <span class="n">instru_fwhm</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">instru_idx_crop</span> <span class="o">=</span> <span class="n">instru_idx</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">final_sp_corr_crop</span> <span class="o">=</span> <span class="n">final_sp_corr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">instru_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;instru_fwhm&#39;</span><span class="p">:</span><span class="n">instru_fwhm_crop</span><span class="p">,</span>
                 <span class="s1">&#39;instru_idx&#39;</span><span class="p">:</span><span class="n">instru_idx_crop</span><span class="p">,</span>
                 <span class="s1">&#39;instru_corr&#39;</span><span class="p">:</span><span class="n">final_sp_corr_crop</span><span class="p">,</span>
                 <span class="s1">&#39;filter_reader&#39;</span><span class="p">:</span><span class="n">filter_reader</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>For this exercice, we have downloaded the MSL library following the instructions on the page of J. Gagné: <a class="reference external" href="https://jgagneastro.com/the-montreal-spectral-library/">https://jgagneastro.com/the-montreal-spectral-library/</a></p>
<p>Below, we then set the folder in which the template spectra placed, and their extension (‘.fits’, for automatic identification of spectra in that folder). We also define the snippet function <code class="docutils literal notranslate"><span class="pre">tmp_reader</span></code> to read the template spectra in the utils.py file, loaded below.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[129]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">tmp_reader</span>
<span class="n">inpath_models</span> <span class="o">=</span> <span class="s1">&#39;../static/MSL/&#39;</span>
<span class="n">tmp_endswith</span><span class="o">=</span><span class="s1">&#39;.fits&#39;</span>
<span class="n">tmp_params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tmp_reader&#39;</span><span class="p">:</span><span class="n">tmp_reader</span><span class="p">,</span>
              <span class="s1">&#39;lib_dir&#39;</span><span class="p">:</span><span class="n">inpath_models</span><span class="p">,</span>
              <span class="s1">&#39;tmp_endswith&#39;</span><span class="p">:</span><span class="n">tmp_endswith</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>Let’s assume we are interested in the top 3 most similar template spectra:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[130]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_best</span><span class="o">=</span><span class="mi">3</span>
</pre></div>
</div>
</div>
<p>Let’s use the Nelder-Mead algorithm to find the optimal flux scaling factor and <span class="math notranslate nohighlight">\(A_V\)</span> to be applied to each template. Additional options for the simplex can be set with <code class="docutils literal notranslate"><span class="pre">simplex_options</span></code> (example above) - these will be provided to the <code class="docutils literal notranslate"><span class="pre">scipy.minimize</span></code> function.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[131]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">search_mode</span> <span class="o">=</span> <span class="s1">&#39;simplex&#39;</span>
<span class="n">simplex_options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;xatol&#39;</span><span class="p">:</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="s1">&#39;fatol&#39;</span><span class="p">:</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">&#39;maxfev&#39;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">}</span>
<span class="n">AV_range</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span> <span class="c1"># min, max, step. Note: in simplex mode, min and max values are only used to set a chi=np.inf outside of these bounds.</span>

<span class="n">search_opt</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;search_mode&#39;</span><span class="p">:</span><span class="n">search_mode</span><span class="p">,</span>
              <span class="s1">&#39;simplex_options&#39;</span><span class="p">:</span><span class="n">simplex_options</span><span class="p">,</span>
              <span class="c1">#&#39;scale_range&#39;:(0.2, 5, 0.05),# min, max, step</span>
              <span class="s1">&#39;ext_range&#39;</span><span class="p">:</span><span class="n">AV_range</span><span class="p">}</span>
</pre></div>
</div>
</div>
<p>Alternatively, one can set <code class="docutils literal notranslate"><span class="pre">search_mode</span></code> to <code class="docutils literal notranslate"><span class="pre">'grid'</span></code>, which will simply use a grid search to find the optimal <span class="math notranslate nohighlight">\(A_V\)</span> and flux scaling factors to be applied to the template spectra for comparison to the measured spectrum. This is slower but avoids the risk of a failed minimization. In this case, both the <code class="docutils literal notranslate"><span class="pre">AV_range</span></code> and <code class="docutils literal notranslate"><span class="pre">scale_range</span></code> parameters have to be set.</p>
<p>Some template spectra may be corrupted or unusable for this specific spectrum (e.g. wrong wavelength coverage), let’s force the algorithm to continue instead of raising an error. Let’s also discard any NaN points from the template spectra:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[132]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">force_continue</span><span class="o">=</span><span class="kc">True</span>
<span class="n">remove_nan</span><span class="o">=</span><span class="kc">True</span>
</pre></div>
</div>
</div>
<p>Now let’s find the best-fit templates:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[133]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.template_fit</span> <span class="kn">import</span> <span class="n">best_fit_tmp</span>

<span class="n">final_res</span> <span class="o">=</span> <span class="n">best_fit_tmp</span><span class="p">(</span><span class="n">lbda_crop</span><span class="p">,</span> <span class="n">spec_crop</span><span class="p">,</span> <span class="n">spec_err_crop</span><span class="p">,</span> <span class="n">dlbda_obs</span><span class="o">=</span><span class="n">dlbda_crop</span><span class="p">,</span> <span class="n">n_best</span><span class="o">=</span><span class="n">n_best</span><span class="p">,</span>
                         <span class="o">**</span><span class="n">tmp_params</span><span class="p">,</span> <span class="o">**</span><span class="n">search_opt</span><span class="p">,</span> <span class="o">**</span><span class="n">instru_params</span><span class="p">,</span> <span class="n">force_continue</span><span class="o">=</span><span class="n">force_continue</span><span class="p">,</span>
                         <span class="n">remove_nan</span><span class="o">=</span><span class="n">remove_nan</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――
Starting time: 2022-02-24 00:08:11
――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――
424 template spectra will be tested.

****************************************

0/424: done in 0:00:00.550965s
Based on the first fit, it may take ~4min to test the whole library

1/424: done in 0:00:00.398344s
2/424: done in 0:00:00.395894s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2353A_merge&#39;       /                                              [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
3/424: done in 0:00:00.458781s
Wavelength range of template SIMPJ1150+0520_NIR_NIRI_Robert2016.fits (0.98, 2.45)mu too short compared to that of observed spectrum (0.95, 2.25)mu
4/424 (SIMPJ1150+0520_NIR_NIRI_Robert2016.fits) FAILED
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template SIMPJ2238+2304_NIR_SpeX_Robert2016.fits. Does the wavelength range extend far enough (0.94, 2.42)mu?
5/424 (SIMPJ2238+2304_NIR_SpeX_Robert2016.fits) FAILED
6/424: done in 0:00:00.483217s
7/424: done in 0:00:00.369481s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2251-6811_ALLCOMB_merge&#39; /                                        [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
8/424: done in 0:00:00.397562s
9/424: done in 0:00:00.382962s
10/424: done in 0:00:00.417756s
11/424: done in 0:00:00.387112s
12/424: done in 0:00:00.432677s
Wavelength range of template SIMPJ2148+2239_NIR_NIRI_Robert2016.fits (0.98, 2.45)mu too short compared to that of observed spectrum (0.95, 2.25)mu
13/424 (SIMPJ2148+2239_NIR_NIRI_Robert2016.fits) FAILED
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2202-5605_ALLCOMB_merge&#39; /                                        [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
14/424: done in 0:00:00.433309s
15/424: done in 0:00:00.407151s
16/424: done in 0:00:00.442868s
17/424: done in 0:00:00.355052s
18/424: done in 0:00:00.417400s
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template SIMPJ1510-1147_NIR_SpeX_Robert2016.fits. Does the wavelength range extend far enough (0.94, 2.43)mu?
19/424 (SIMPJ1510-1147_NIR_SpeX_Robert2016.fits) FAILED
20/424: done in 0:00:00.448485s
Wavelength range of template SIMPJ1613-0747_NIR_NIRI_Robert2016.fits (0.98, 2.45)mu too short compared to that of observed spectrum (0.95, 2.25)mu
21/424 (SIMPJ1613-0747_NIR_NIRI_Robert2016.fits) FAILED
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2240+0532_merge&#39;   /                                              [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
22/424: done in 0:00:00.411015s
23/424: done in 0:00:00.265716s
Wavelength range of template SIMPJ1225-1013_NIR_GNIRS_Robert2016.fits (1.00, 2.52)mu too short compared to that of observed spectrum (0.95, 2.25)mu
24/424 (SIMPJ1225-1013_NIR_GNIRS_Robert2016.fits) FAILED
No indices match the constraint (ceil w.r.t 2.31)
Issue with resampling of template SIMPJ2318-1301_NIR_SIMON_Robert2016.fits. Does the wavelength range extend far enough (0.80, 2.27)mu?
25/424 (SIMPJ2318-1301_NIR_SIMON_Robert2016.fits) FAILED
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/Users/valentin/GitHub/special/special/model_resampling.py:719: RuntimeWarning: invalid value encountered in multiply
  num = np.sum(interp_trans*dlbda_mod[idx_ini:idx_fin]*spec_mod[idx_ini:idx_fin])
/Users/valentin/opt/miniconda3/envs/spec_env/lib/python3.9/site-packages/numpy/core/fromnumeric.py:86: RuntimeWarning: invalid value encountered in reduce
  return ufunc.reduce(obj, axis, dtype, out, **passkwargs)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
26/424 (SIMPJ1217+0708_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
27/424 (SIMPJ0858+2710_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
28/424: done in 0:00:21.936539s
29/424: done in 0:00:00.376009s
30/424: done in 0:00:00.393715s
31/424: done in 0:00:00.462755s
Wavelength range of template SIMPJ1756+2815_NIR_NIRI_Robert2016.fits (0.98, 2.45)mu too short compared to that of observed spectrum (0.95, 2.25)mu
32/424 (SIMPJ1756+2815_NIR_NIRI_Robert2016.fits) FAILED
33/424: done in 0:00:00.467715s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2041-3506_ALLCOMB_merge&#39; /                                        [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
34/424: done in 0:00:00.444484s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J22191486-6828018_ALLCOMB_merge&#39; /                                 [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
35/424: done in 0:00:00.458515s
36/424: done in 0:00:00.507436s
37/424: done in 0:00:00.401349s
38/424: done in 0:00:00.408882s
39/424 (SIMPJ0851+1043_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
40/424: done in 0:00:11.459940s
41/424: done in 0:00:00.453456s
42/424: done in 0:00:00.415972s
Wavelength range of template SIMPJ1755+3618_NIR_NIRI_Robert2016.fits (0.98, 2.45)mu too short compared to that of observed spectrum (0.95, 2.25)mu
43/424 (SIMPJ1755+3618_NIR_NIRI_Robert2016.fits) FAILED
44/424: done in 0:00:00.567020s
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template 2MASSJ0042+1142_NIR_SpeX_Gagne2015c.fits. Does the wavelength range extend far enough (0.94, 2.42)mu?
45/424 (2MASSJ0042+1142_NIR_SpeX_Gagne2015c.fits) FAILED
46/424: done in 0:00:00.438209s
47/424: done in 0:00:00.430337s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2244-3045_merge&#39;   /                                              [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
48/424: done in 0:00:00.456478s
Wavelength range of template SIMPJ1414+0107_NIR_NIRI_Robert2016.fits (0.98, 2.45)mu too short compared to that of observed spectrum (0.95, 2.25)mu
49/424 (SIMPJ1414+0107_NIR_NIRI_Robert2016.fits) FAILED
50/424: done in 0:00:00.472526s
51/424: done in 0:00:00.414303s
52/424 (SIMPJ1058+1339_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
53/424: done in 0:00:11.410178s
54/424: done in 0:00:00.494682s
55/424: done in 0:00:00.449454s
56/424: done in 0:00:00.399874s
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template SIMPJ0418+1121_NIR_SpeX_Robert2016.fits. Does the wavelength range extend far enough (0.94, 2.43)mu?
57/424 (SIMPJ0418+1121_NIR_SpeX_Robert2016.fits) FAILED
58/424: done in 0:00:00.473392s
59/424: done in 0:00:00.402355s
60/424: done in 0:00:00.364772s
61/424: done in 0:00:00.341495s
62/424 (SIMPJ1453-2744_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
63/424: done in 0:00:11.371247s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2335-3401_ALLCOMB_merge&#39; /                                        [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
64/424: done in 0:00:00.435717s
65/424: done in 0:00:00.402772s
66/424: done in 0:00:00.452244s
67/424: done in 0:00:00.570082s
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template 2MASSJ1547-1626B_NIR_SpeX_Gagne2015c.fits. Does the wavelength range extend far enough (0.94, 2.42)mu?
68/424 (2MASSJ1547-1626B_NIR_SpeX_Gagne2015c.fits) FAILED
69/424: done in 0:00:00.471967s
70/424: done in 0:00:00.493733s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;W2011-5048_tc.fits&#39; /                                              [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
71/424: done in 0:00:00.366275s
72/424: done in 0:00:00.355822s
73/424: done in 0:00:00.443078s
74/424: done in 0:00:00.345989s
75/424: done in 0:00:00.390501s
76/424 (SIMPJ1211+0406_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
77/424: done in 0:00:11.156385s
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template 2MASSJ0314+1603_NIR_SpeX_Gagne2015c.fits. Does the wavelength range extend far enough (0.94, 2.42)mu?
78/424 (2MASSJ0314+1603_NIR_SpeX_Gagne2015c.fits) FAILED
79/424: done in 0:00:00.431940s
80/424: done in 0:00:00.421758s
81/424: done in 0:00:00.411011s
2MASSJ0039+1330B_NIR_SpeX_Gagne2015c.fits could not be opened. Corrupt file?
82/424 (2MASSJ0039+1330B_NIR_SpeX_Gagne2015c.fits) FAILED
83/424: done in 0:00:00.443581s
84/424: done in 0:00:00.413381s
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template SIMPJ0422+1033_NIR_SpeX_Robert2016.fits. Does the wavelength range extend far enough (0.94, 2.43)mu?
85/424 (SIMPJ0422+1033_NIR_SpeX_Robert2016.fits) FAILED
86/424: done in 0:00:00.458336s
87/424: done in 0:00:00.482146s
88/424: done in 0:00:00.523616s
89/424: done in 0:00:00.450691s
90/424: done in 0:00:00.386252s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2244-6650_ALLCOMB_merge&#39; /                                        [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
91/424: done in 0:00:00.379430s
92/424: done in 0:00:00.385305s
93/424: done in 0:00:00.370226s
94/424: done in 0:00:00.399188s
95/424: done in 0:00:00.378416s
96/424: done in 0:00:00.381476s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2335-1908_merge&#39;   /                                              [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
97/424: done in 0:00:00.417464s
98/424: done in 0:00:00.440879s
Wavelength range of template SIMPJ1158+0435_NIR_SpeX_Robert2016.fits (1.13, 2.43)mu too short compared to that of observed spectrum (0.95, 2.25)mu
99/424 (SIMPJ1158+0435_NIR_SpeX_Robert2016.fits) FAILED
2MASSJ0002+0408A_NIR_SpeX_Gagne2015c.fits could not be opened. Corrupt file?
100/424 (2MASSJ0002+0408A_NIR_SpeX_Gagne2015c.fits) FAILED
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;W2343-3646_tc.fits&#39; /                                              [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
101/424: done in 0:00:00.352370s
102/424 (SIMPJ0006-1319_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
103/424 (SIMPJ0532-3253_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
104/424: done in 0:00:22.635250s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2028-5637_ALLCOMB_merge&#39; /                                        [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
105/424: done in 0:00:00.418264s
106/424: done in 0:00:00.411382s
107/424: done in 0:00:00.592454s
Wavelength range of template 2MASSJ2235-5906_NIR_Flamingos-2_Gagne2015c.fits (0.89, 1.77)mu too short compared to that of observed spectrum (0.95, 2.25)mu
108/424 (2MASSJ2235-5906_NIR_Flamingos-2_Gagne2015c.fits) FAILED
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2235-5906_BEAMS_AB_140710_386_387_388_389_comb.fits&#39; /            [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
109/424: done in 0:00:00.575307s
110/424: done in 0:00:00.379437s
111/424: done in 0:00:00.467553s
112/424 (SIMPJ1307-0558_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
113/424: done in 0:00:11.789503s
Wavelength range of template SIMPJ1118-0856_NIR_NIRI_Robert2016.fits (0.98, 2.45)mu too short compared to that of observed spectrum (0.95, 2.25)mu
114/424 (SIMPJ1118-0856_NIR_NIRI_Robert2016.fits) FAILED
115/424: done in 0:00:00.582817s
116/424: done in 0:00:00.846217s
117/424 (SIMPJ0400-1322_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
Wavelength range of template 2MASSJ1207-3900_OPT_MAGE_Gagne2014b.fits (38240.71, 43051.20)mu too short compared to that of observed spectrum (0.95, 2.25)mu
118/424 (2MASSJ1207-3900_OPT_MAGE_Gagne2014b.fits) FAILED
119/424: done in 0:00:13.124367s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J20004841-7523070_ALLCOMB_merge&#39; /                                 [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
120/424: done in 0:00:00.374794s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: non-ASCII characters are present in the FITS file header and have been replaced by &#34;?&#34; characters [astropy.io.fits.util]
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;spc0070.a.fits&#39;                                                    [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
121/424: done in 0:00:00.441934s
122/424: done in 0:00:00.323633s
123/424: done in 0:00:00.369961s
Wavelength range of template SIMPJ1333-0215_NIR_SpeX_Robert2016.fits (1.13, 2.43)mu too short compared to that of observed spectrum (0.95, 2.25)mu
124/424 (SIMPJ1333-0215_NIR_SpeX_Robert2016.fits) FAILED
125/424: done in 0:00:00.432600s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2310-0748_merge&#39;   /                                              [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
126/424: done in 0:00:00.422035s
127/424: done in 0:00:00.406225s
128/424 (SIMPJ1613-0747_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
129/424 (SIMPJ0552+0210_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
130/424: done in 0:00:22.344974s
131/424: done in 0:00:00.422269s
132/424: done in 0:00:00.469305s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;W2315-4747_tc.fits&#39; /                                              [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
133/424: done in 0:00:00.402940s
134/424: done in 0:00:00.358859s
135/424: done in 0:00:00.410161s
Wavelength range of template 2MASSJ0320-3313_NIR_Flamingos-2_Gagne2015c.fits (1.00, 2.42)mu too short compared to that of observed spectrum (0.95, 2.25)mu
136/424 (2MASSJ0320-3313_NIR_Flamingos-2_Gagne2015c.fits) FAILED
137/424: done in 0:00:00.464893s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;W2048-5127_tc.fits&#39; /                                              [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
138/424: done in 0:00:00.397498s
Wavelength range of template SIMPJ1004-1127_NIR_GNIRS_Robert2016.fits (1.00, 2.52)mu too short compared to that of observed spectrum (0.95, 2.25)mu
139/424 (SIMPJ1004-1127_NIR_GNIRS_Robert2016.fits) FAILED
140/424: done in 0:00:00.400547s
141/424: done in 0:00:00.430415s
142/424: done in 0:00:00.394625s
143/424: done in 0:00:00.379749s
144/424: done in 0:00:00.353829s
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template 2MASSJ2048-3255_NIR_SpeX_Gagne2015c.fits. Does the wavelength range extend far enough (0.94, 2.42)mu?
145/424 (2MASSJ2048-3255_NIR_SpeX_Gagne2015c.fits) FAILED
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2048-3255_merge&#39;   /                                              [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
146/424: done in 0:00:00.476342s
SIMPJ2332-1249_NIR_SpeX_Robert2016.fits could not be opened. Corrupt file?
147/424 (SIMPJ2332-1249_NIR_SpeX_Robert2016.fits) FAILED
148/424: done in 0:00:00.413131s
149/424: done in 0:00:00.402007s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2327+3858_merge&#39;   /                                              [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
150/424: done in 0:00:00.400297s
151/424: done in 0:00:00.435834s
152/424: done in 0:00:00.395564s
153/424: done in 0:00:00.402030s
154/424: done in 0:00:00.419028s
155/424: done in 0:00:00.408384s
156/424: done in 0:00:00.417780s
157/424: done in 0:00:00.389834s
No indices match the constraint (ceil w.r.t 2.31)
Issue with resampling of template 2MASSJ0342-2904_NIR_FIRE_Gagne2015c.fits. Does the wavelength range extend far enough (0.83, 2.30)mu?
158/424 (2MASSJ0342-2904_NIR_FIRE_Gagne2015c.fits) FAILED
159/424: done in 0:00:00.432195s
160/424: done in 0:00:00.460123s
161/424: done in 0:00:00.363011s
162/424 (SIMPJ0921-1534_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template 2MASSJ1706-1314_NIR_SpeX_Gagne2015c.fits. Does the wavelength range extend far enough (0.94, 2.42)mu?
163/424 (2MASSJ1706-1314_NIR_SpeX_Gagne2015c.fits) FAILED
164/424: done in 0:00:11.649976s
165/424: done in 0:00:00.383753s
166/424: done in 0:00:00.403327s
167/424: done in 0:00:00.490177s
168/424: done in 0:00:00.473191s
169/424 (SIMPJ1629+0335_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
Wavelength range of template SIMPJ2132-1452_NIR_NIRI_Robert2016.fits (0.98, 2.45)mu too short compared to that of observed spectrum (0.95, 2.25)mu
170/424 (SIMPJ2132-1452_NIR_NIRI_Robert2016.fits) FAILED
171/424: done in 0:00:11.421720s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2149-6413_ALLCOMB_merge&#39; /                                        [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
172/424: done in 0:00:00.456015s
Wavelength range of template SIMPJ1039-2829_NIR_NIRI_Robert2016.fits (0.98, 2.45)mu too short compared to that of observed spectrum (0.95, 2.25)mu
173/424 (SIMPJ1039-2829_NIR_NIRI_Robert2016.fits) FAILED
174/424: done in 0:00:00.445408s
175/424: done in 0:00:00.420493s
176/424: done in 0:00:00.363355s
177/424: done in 0:00:00.308029s
178/424: done in 0:00:00.301674s
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template 2MASSJ2325-0259_NIR_SpeX_Gagne2015c.fits. Does the wavelength range extend far enough (0.94, 2.42)mu?
179/424 (2MASSJ2325-0259_NIR_SpeX_Gagne2015c.fits) FAILED
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template 2MASSJ0407+1546_NIR_SpeX_Gagne2015c.fits. Does the wavelength range extend far enough (0.94, 2.42)mu?
180/424 (2MASSJ0407+1546_NIR_SpeX_Gagne2015c.fits) FAILED
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2325-0259&#39;         /                                              [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
181/424: done in 0:00:00.423037s
182/424: done in 0:00:00.473594s
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template GUPscb_NIR_GNIRS_Naud2014.fits. Does the wavelength range extend far enough (0.94, 2.35)mu?
183/424 (GUPscb_NIR_GNIRS_Naud2014.fits) FAILED
Wavelength range of template SIMPJ1132-3809_NIR_NIRI_Robert2016.fits (0.98, 2.45)mu too short compared to that of observed spectrum (0.95, 2.25)mu
184/424 (SIMPJ1132-3809_NIR_NIRI_Robert2016.fits) FAILED
185/424: done in 0:00:00.482249s
186/424: done in 0:00:00.400055s
187/424: done in 0:00:00.410672s
188/424: done in 0:00:00.401389s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2112-8128_ALLCOMB_merge&#39; /                                        [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
189/424: done in 0:00:00.373017s
190/424: done in 0:00:00.395590s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;W1939-5216_tc.fits&#39; /                                              [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
191/424: done in 0:00:00.417783s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2148-4736_ALLCOMB_merge&#39; /                                        [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
192/424: done in 0:00:00.379529s
193/424 (SIMPJ1117+1857_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template 2MASSJ0355+1133_NIR_SpeX_Gagne2015c.fits. Does the wavelength range extend far enough (0.94, 2.42)mu?
194/424 (2MASSJ0355+1133_NIR_SpeX_Gagne2015c.fits) FAILED
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2005-6258_ALLCOMB_merge&#39; /                                        [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
195/424: done in 0:00:11.439056s
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template SIMPJ0211-1427_NIR_SpeX_Robert2016.fits. Does the wavelength range extend far enough (0.94, 2.42)mu?
196/424 (SIMPJ0211-1427_NIR_SpeX_Robert2016.fits) FAILED
197/424 (SIMPJ1041-0429_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
198/424: done in 0:00:11.245609s
Wavelength range of template SIMPJ1343-1216_NIR_NIRI_Robert2016.fits (0.98, 2.45)mu too short compared to that of observed spectrum (0.95, 2.25)mu
199/424 (SIMPJ1343-1216_NIR_NIRI_Robert2016.fits) FAILED
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J1903-3723_ALLCOMB_merge&#39; /                                        [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
200/424: done in 0:00:00.438834s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J1948+5944A_merge&#39;  /                                              [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
201/424: done in 0:00:00.405153s
Wavelength range of template 2MASSJ1846-5706_NIR_Flamingos-2_Gagne2015c.fits (0.90, 1.88)mu too short compared to that of observed spectrum (0.95, 2.25)mu
202/424 (2MASSJ1846-5706_NIR_Flamingos-2_Gagne2015c.fits) FAILED
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template 2MASSJ0453-1751_NIR_SpeX_Gagne2015c.fits. Does the wavelength range extend far enough (0.94, 2.42)mu?
203/424 (2MASSJ0453-1751_NIR_SpeX_Gagne2015c.fits) FAILED
204/424: done in 0:00:00.501226s
205/424 (SIMPJ1537-0800_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
Wavelength range of template SIMPJ2322-1407_NIR_NIRI_Robert2016.fits (0.98, 2.45)mu too short compared to that of observed spectrum (0.95, 2.25)mu
206/424 (SIMPJ2322-1407_NIR_NIRI_Robert2016.fits) FAILED
207/424: done in 0:00:10.997802s
208/424: done in 0:00:00.463886s
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template 2MASSJ1547-1626A_NIR_SpeX_Gagne2015c.fits. Does the wavelength range extend far enough (0.94, 2.42)mu?
209/424 (2MASSJ1547-1626A_NIR_SpeX_Gagne2015c.fits) FAILED
210/424 (SIMPJ0425-1900_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
211/424: done in 0:00:12.169934s
212/424: done in 0:00:00.396936s
213/424: done in 0:00:00.346030s
214/424: done in 0:00:00.371781s
215/424: done in 0:00:00.346394s
216/424 (SIMPJ0421-1133_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
217/424: done in 0:00:11.177275s
218/424: done in 0:00:00.516700s
219/424: done in 0:00:00.356396s
220/424: done in 0:00:00.387175s
221/424 (SIMPJ0936+0528_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
222/424: done in 0:00:11.022330s
223/424: done in 0:00:00.366914s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_F-TLM= &#39;2013-07-18T21:19:33&#39; / Time of last modification                   [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
224/424: done in 0:00:00.578650s
225/424: done in 0:00:00.351763s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J1846+5246_A_merge&#39; /                                              [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
226/424: done in 0:00:00.486143s
2MASSJ0039+1330A_NIR_SpeX_Gagne2015c.fits could not be opened. Corrupt file?
227/424 (2MASSJ0039+1330A_NIR_SpeX_Gagne2015c.fits) FAILED
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J12574463-3635431_ALLCOMB_merge&#39; /                                 [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
228/424: done in 0:00:00.387912s
229/424: done in 0:00:00.393150s
230/424: done in 0:00:00.345789s
231/424 (SIMPJ1141+1941_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template SIMPJ1003-1441_NIR_SpeX_Robert2016.fits. Does the wavelength range extend far enough (0.94, 2.43)mu?
232/424 (SIMPJ1003-1441_NIR_SpeX_Robert2016.fits) FAILED
233/424: done in 0:00:11.175260s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2235-3844_ALLCOMB_merge&#39; /                                        [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
234/424: done in 0:00:00.461598s
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template 2MASSJ0326-0617_NIR_SpeX_Gagne2015c.fits. Does the wavelength range extend far enough (0.94, 2.42)mu?
235/424 (2MASSJ0326-0617_NIR_SpeX_Gagne2015c.fits) FAILED
236/424: done in 0:00:00.474967s
237/424: done in 0:00:00.379381s
2MASSJ2331-0406_NIR_Flamingos-2_Gagne2015c.fits could not be opened. Corrupt file?
238/424 (2MASSJ2331-0406_NIR_Flamingos-2_Gagne2015c.fits) FAILED
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: VerifyWarning: Error validating header for HDU #0 (note: Astropy uses zero-based indexing).
    Header size is not multiple of 2880: 11366
There may be extra bytes after the last HDU or the file is corrupted. [astropy.io.fits.hdu.hdulist]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
239/424: done in 0:00:00.403177s
240/424: done in 0:00:00.435607s
241/424: done in 0:00:00.497739s
242/424: done in 0:00:00.410610s
243/424: done in 0:00:00.423182s
244/424: done in 0:00:00.374003s
245/424: done in 0:00:00.489074s
2MASSJ0017-3219_NIR_Flamingos-2_Gagne2015c.fits could not be opened. Corrupt file?
246/424 (2MASSJ0017-3219_NIR_Flamingos-2_Gagne2015c.fits) FAILED
247/424: done in 0:00:00.411054s
248/424: done in 0:00:00.521418s
249/424: done in 0:00:00.401616s
250/424: done in 0:00:00.427319s
251/424: done in 0:00:00.390679s
252/424: done in 0:00:00.404093s
253/424: done in 0:00:00.387570s
254/424: done in 0:00:00.394857s
255/424: done in 0:00:00.371344s
256/424: done in 0:00:00.376281s
257/424: done in 0:00:00.365331s
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template SIMPJ0417+1634_NIR_SpeX_Robert2016.fits. Does the wavelength range extend far enough (0.94, 2.42)mu?
258/424 (SIMPJ0417+1634_NIR_SpeX_Robert2016.fits) FAILED
259/424: done in 0:00:00.425649s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J19350976-6200473_ALLCOMB_merge&#39; /                                 [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
260/424: done in 0:00:00.446697s
SIMPJ2344+0909_NIR_GNIRS_Robert2016.fits could not be opened. Corrupt file?
261/424 (SIMPJ2344+0909_NIR_GNIRS_Robert2016.fits) FAILED
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2202-1109_merge&#39;   /                                              [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
262/424: done in 0:00:00.547233s
2MASSJ0103-2805A_NIR_SpeX_Gagne2015c.fits could not be opened. Corrupt file?
263/424 (2MASSJ0103-2805A_NIR_SpeX_Gagne2015c.fits) FAILED
264/424: done in 0:00:00.439825s
265/424: done in 0:00:00.365238s
266/424: done in 0:00:00.405195s
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template SIMPJ1654+3747_NIR_SpeX_Robert2016.fits. Does the wavelength range extend far enough (0.94, 2.43)mu?
267/424 (SIMPJ1654+3747_NIR_SpeX_Robert2016.fits) FAILED
268/424: done in 0:00:00.519927s
269/424: done in 0:00:00.401164s
270/424: done in 0:00:00.434383s
271/424 (SIMPJ0946+0922_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
272/424 (SIMPJ0307+0852_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
Wavelength range of template 2MASSJ2336-3541_NIR_Flamingos-2_Gagne2015c.fits (0.90, 1.77)mu too short compared to that of observed spectrum (0.95, 2.25)mu
273/424 (2MASSJ2336-3541_NIR_Flamingos-2_Gagne2015c.fits) FAILED
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2336-3541_BEAMS_AB_140710_397_398_399_400_comb.fits&#39; /            [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
274/424 (SIMPJ1036+0306_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2033-3733_ALLCOMB_merge&#39; /                                        [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
275/424: done in 0:00:31.443600s
276/424: done in 0:00:00.403662s
277/424 (SIMPJ1052+1722_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
278/424: done in 0:00:10.273698s
279/424: done in 0:00:00.437733s
280/424: done in 0:00:00.365918s
281/424: done in 0:00:00.407793s
282/424: done in 0:00:00.369618s
283/424: done in 0:00:00.345676s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2114-4339_merge&#39;   /                                              [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
284/424: done in 0:00:00.403562s
285/424: done in 0:00:00.387947s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J20505221-3639552_ALLCOMB_merge&#39; /                                 [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
286/424: done in 0:00:00.326041s
287/424 (SIMPJ2304+0749_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
288/424 (SIMPJ0136+0933_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
289/424: done in 0:00:20.872968s
290/424: done in 0:00:00.359919s
291/424: done in 0:00:00.379533s
292/424 (SIMPJ2330+1006_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2322-6151_ALLCOMB_merge&#39; /                                        [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
293/424: done in 0:00:10.519500s
294/424: done in 0:00:00.430685s
295/424: done in 0:00:00.411753s
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template 2MASSJ1622-2346_NIR_SpeX_Gagne2015c.fits. Does the wavelength range extend far enough (0.94, 2.42)mu?
296/424 (2MASSJ1622-2346_NIR_SpeX_Gagne2015c.fits) FAILED
297/424 (SIMPJ1343+1312_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
Wavelength range of template SIMPJ0006-2158_NIR_NIRI_Robert2016.fits (0.98, 2.45)mu too short compared to that of observed spectrum (0.95, 2.25)mu
298/424 (SIMPJ0006-2158_NIR_NIRI_Robert2016.fits) FAILED
299/424: done in 0:00:10.842007s
Wavelength range of template SIMPJ1615+1340_NIR_GNIRS_Robert2016.fits (1.00, 2.52)mu too short compared to that of observed spectrum (0.95, 2.25)mu
300/424 (SIMPJ1615+1340_NIR_GNIRS_Robert2016.fits) FAILED
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template 2MASSJ0501-0010_NIR_SpeX_Gagne2015c.fits. Does the wavelength range extend far enough (0.94, 2.42)mu?
301/424 (2MASSJ0501-0010_NIR_SpeX_Gagne2015c.fits) FAILED
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2329_tell.fits&#39;    /                                              [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
302/424: done in 0:00:00.378820s
303/424: done in 0:00:00.388424s
Wavelength range of template DENISJ0817-6155_NIR_OSIRIS_Artigau2010.fits (1.13, 2.36)mu too short compared to that of observed spectrum (0.95, 2.25)mu
304/424 (DENISJ0817-6155_NIR_OSIRIS_Artigau2010.fits) FAILED
305/424: done in 0:00:00.372202s
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template 2MASSJ1051-1916_NIR_SpeX_Gagne2015c.fits. Does the wavelength range extend far enough (0.94, 2.42)mu?
306/424 (2MASSJ1051-1916_NIR_SpeX_Gagne2015c.fits) FAILED
SIMPJ2351+3010_NIR_SpeX_Robert2016.fits could not be opened. Corrupt file?
307/424 (SIMPJ2351+3010_NIR_SpeX_Robert2016.fits) FAILED
308/424 (SIMPJ1339+1523_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
309/424: done in 0:00:10.485362s
310/424 (SIMPJ1422+0827_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
311/424: done in 0:00:10.495399s
312/424: done in 0:00:00.324919s
313/424: done in 0:00:00.388634s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J1839+2952_merge&#39;   /                                              [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
314/424: done in 0:00:00.376811s
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template 2MASSJ2002-1316_NIR_SpeX_Gagne2015c.fits. Does the wavelength range extend far enough (0.94, 2.42)mu?
315/424 (2MASSJ2002-1316_NIR_SpeX_Gagne2015c.fits) FAILED
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2002-1316_merge&#39;   /                                              [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
316/424 (SIMPJ1147-1032_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
Wavelength range of template SIMPJ1039+2440_NIR_NIRI_Robert2016.fits (0.98, 2.45)mu too short compared to that of observed spectrum (0.95, 2.25)mu
317/424 (SIMPJ1039+2440_NIR_NIRI_Robert2016.fits) FAILED
318/424: done in 0:00:10.765531s
Wavelength range of template SIMPJ0004-2007_NIR_NIRI_Robert2016.fits (0.98, 2.45)mu too short compared to that of observed spectrum (0.95, 2.25)mu
319/424 (SIMPJ0004-2007_NIR_NIRI_Robert2016.fits) FAILED
320/424: done in 0:00:00.421960s
321/424: done in 0:00:00.336844s
322/424: done in 0:00:00.405547s
323/424: done in 0:00:00.320273s
324/424 (SIMPJ1308+0432_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template SIMPJ1623-0508_NIR_SpeX_Robert2016.fits. Does the wavelength range extend far enough (0.94, 2.43)mu?
325/424 (SIMPJ1623-0508_NIR_SpeX_Robert2016.fits) FAILED
326/424: done in 0:00:10.451500s
Wavelength range of template SIMPJ1533+2044_NIR_NIRI_Robert2016.fits (0.98, 2.45)mu too short compared to that of observed spectrum (0.95, 2.25)mu
327/424 (SIMPJ1533+2044_NIR_NIRI_Robert2016.fits) FAILED
328/424: done in 0:00:00.374589s
329/424: done in 0:00:00.331778s
330/424: done in 0:00:00.327394s
331/424: done in 0:00:00.400068s
332/424: done in 0:00:00.344322s
333/424: done in 0:00:00.420101s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2039-1126_merge&#39;   /                                              [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
334/424: done in 0:00:00.413597s
335/424: done in 0:00:00.462830s
336/424: done in 0:00:00.350870s
337/424: done in 0:00:00.364221s
338/424: done in 0:00:00.362896s
339/424: done in 0:00:00.361082s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2313-6127_ALLCOMB_merge&#39; /                                        [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
340/424: done in 0:00:00.416784s
341/424: done in 0:00:00.321627s
342/424 (SIMPJ1009+1559_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
343/424: done in 0:00:10.435554s
344/424: done in 0:00:00.416737s
345/424: done in 0:00:00.414730s
346/424: done in 0:00:00.386199s
347/424: done in 0:00:00.335646s
348/424: done in 0:00:00.403181s
349/424: done in 0:00:00.342314s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2322-6151B_ALLCOMB_merge&#39; /                                       [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
350/424: done in 0:00:00.377995s
351/424: done in 0:00:00.315666s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_F-TLM= &#39;2013-07-18T20:09:23&#39; / Time of last modification                   [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
352/424: done in 0:00:00.456339s
353/424: done in 0:00:00.440531s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;W2206-6116_tc.fits&#39; /                                              [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
354/424: done in 0:00:00.391086s
355/424: done in 0:00:00.386461s
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template SIMPJ1455+2619_NIR_SpeX_Robert2016.fits. Does the wavelength range extend far enough (0.94, 2.43)mu?
356/424 (SIMPJ1455+2619_NIR_SpeX_Robert2016.fits) FAILED
357/424: done in 0:00:00.370933s
358/424 (SIMPJ1127+1234_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
Wavelength range of template SIMPJ1756+3343_NIR_NIRI_Robert2016.fits (0.98, 2.45)mu too short compared to that of observed spectrum (0.95, 2.25)mu
359/424 (SIMPJ1756+3343_NIR_NIRI_Robert2016.fits) FAILED
360/424: done in 0:00:10.294411s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2257-5041_ALLCOMB_merge&#39; /                                        [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
361/424: done in 0:00:00.355091s
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template 2MASSJ1301-1510_NIR_SpeX_Gagne2015c.fits. Does the wavelength range extend far enough (0.95, 2.42)mu?
362/424 (2MASSJ1301-1510_NIR_SpeX_Gagne2015c.fits) FAILED
363/424: done in 0:00:00.396525s
364/424: done in 0:00:00.335324s
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template 2MASSJ2154-7459_NIR_Flamingos-2_Gagne2015c.fits. Does the wavelength range extend far enough (0.94, 2.42)mu?
365/424 (2MASSJ2154-7459_NIR_Flamingos-2_Gagne2015c.fits) FAILED
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2154-7459_ALLCOMB_merge&#39; /                                        [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
366/424: done in 0:00:00.404885s
Wavelength range of template SIMPJ1143+1905_NIR_NIRI_Robert2016.fits (0.98, 2.45)mu too short compared to that of observed spectrum (0.95, 2.25)mu
367/424 (SIMPJ1143+1905_NIR_NIRI_Robert2016.fits) FAILED
Wavelength range of template SIMPJ2315+2235_NIR_NIRI_Robert2016.fits (0.98, 2.45)mu too short compared to that of observed spectrum (0.95, 2.25)mu
368/424 (SIMPJ2315+2235_NIR_NIRI_Robert2016.fits) FAILED
369/424: done in 0:00:00.389927s
370/424: done in 0:00:00.424673s
371/424: done in 0:00:00.303943s
372/424: done in 0:00:00.303544s
373/424: done in 0:00:00.381679s
374/424: done in 0:00:00.343591s
375/424: done in 0:00:00.380747s
Wavelength range of template SIMPJ0102+0355_NIR_GNIRS_Robert2016.fits (1.00, 2.52)mu too short compared to that of observed spectrum (0.95, 2.25)mu
376/424 (SIMPJ0102+0355_NIR_GNIRS_Robert2016.fits) FAILED
377/424: done in 0:00:00.442665s
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template SIMPJ0940+2946_NIR_SpeX_Robert2016.fits. Does the wavelength range extend far enough (0.94, 2.42)mu?
378/424 (SIMPJ0940+2946_NIR_SpeX_Robert2016.fits) FAILED
379/424: done in 0:00:00.426017s
380/424: done in 0:00:00.399087s
381/424: done in 0:00:00.367248s
382/424: done in 0:00:00.447496s
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template SIMPJ0956-1910_NIR_SpeX_Robert2016.fits. Does the wavelength range extend far enough (0.94, 2.43)mu?
383/424 (SIMPJ0956-1910_NIR_SpeX_Robert2016.fits) FAILED
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2038-4118_ALLCOMB_merge&#39; /                                        [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
384/424: done in 0:00:00.382791s
385/424 (SIMPJ1013-1946_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2314-5405_ALLCOMB_merge&#39; /                                        [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
386/424: done in 0:00:10.860821s
387/424: done in 0:00:00.440462s
388/424 (SIMPJ1108+0838_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
389/424: done in 0:00:10.402625s
390/424: done in 0:00:00.401881s
391/424: done in 0:00:00.357411s
2MASSJ0017-0316_NIR_SpeX_Gagne2015c.fits could not be opened. Corrupt file?
392/424 (2MASSJ0017-0316_NIR_SpeX_Gagne2015c.fits) FAILED
393/424 (SIMPJ0421-1950_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
394/424: done in 0:00:10.517240s
395/424: done in 0:00:00.440231s
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2134-1840_ALLCOMB_merge&#39; /                                        [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
396/424: done in 0:00:00.350674s
Wavelength range of template 2MASSJ1253-4211_NIR_Flamingos-2_Gagne2015c.fits (0.90, 1.75)mu too short compared to that of observed spectrum (0.95, 2.25)mu
397/424 (2MASSJ1253-4211_NIR_Flamingos-2_Gagne2015c.fits) FAILED
398/424: done in 0:00:00.406669s
399/424 (SIMPJ1102+1629_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
400/424: done in 0:00:10.724042s
401/424: done in 0:00:00.399334s
402/424: done in 0:00:00.350190s
403/424: done in 0:00:00.360358s
404/424: done in 0:00:00.385463s
405/424 (SIMPJ1218-1332_NIR_GNIRS_Robert2016.fits) FAILED (simplex did not converge)
406/424: done in 0:00:10.274905s
407/424: done in 0:00:00.347630s
408/424: done in 0:00:00.380562s
409/424: done in 0:00:00.323067s
2MASSJ0002+0408B_NIR_SpeX_Gagne2015c.fits could not be opened. Corrupt file?
410/424 (2MASSJ0002+0408B_NIR_SpeX_Gagne2015c.fits) FAILED
411/424: done in 0:00:00.403932s
412/424: done in 0:00:00.391807s
413/424: done in 0:00:00.449213s
414/424: done in 0:00:00.340611s
415/424: done in 0:00:00.352992s
416/424: done in 0:00:00.362636s
417/424: done in 0:00:00.394638s
418/424: done in 0:00:00.543005s
No indices match the constraint (floor w.r.t 0.93)
Issue with resampling of template SIMPJ0151+3824_NIR_SpeX_Robert2016.fits. Does the wavelength range extend far enough (0.94, 2.42)mu?
419/424 (SIMPJ0151+3824_NIR_SpeX_Robert2016.fits) FAILED
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING: The following header keyword is invalid or follows an unrecognized non-standard convention:
I_R_A_FNAME= &#39;J2022-5645_ALLCOMB_merge&#39; /                                        [astropy.io.fits.card]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
420/424: done in 0:00:00.444064s
421/424: done in 0:00:00.399248s
422/424: done in 0:00:00.384418s
423/424: done in 0:00:00.403806s
****************************************

308/424 template spectra were fitted.

Running time:  0:09:11.705892
――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――――
best chi:  [2.88768921 2.99549636 3.20434253]
best scale fac:  [0.02401384 0.0112894  0.01819982]
n_dof:  [39. 39. 39.]
The best template #1 is: 2MASSJ0507+1430B_NIR_SpeX_Gagne2015c.fits (Delta A_V=1.7mag)

The best template #2 is: GUPscA_NIR_SpeX_Naud2014.fits (Delta A_V=2.2mag)

The best template #3 is: 2MASSJ0339-2434_NIR_SpeX_Gagne2015c.fits (Delta A_V=2.0mag)

</pre></div></div>
</div>
<p>Let’s load the results, and prepare a list of short template names (for display; i.e. without the suffix):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[134]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">final_tmpname</span><span class="p">,</span> <span class="n">final_tmp</span><span class="p">,</span> <span class="n">final_chi</span><span class="p">,</span> <span class="n">final_params</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">final_res</span>

<span class="n">n_end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp_endswith</span><span class="p">)</span>
<span class="n">short_tmpname</span> <span class="o">=</span> <span class="p">[</span><span class="n">final_tmpname</span><span class="p">[</span><span class="n">i</span><span class="p">][:</span><span class="o">-</span><span class="n">n_end</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">final_tmpname</span><span class="p">))]</span>
<span class="n">short_tmpname</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[134]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;2MASSJ0507+1430B_NIR_SpeX_Gagne2015c&#39;,
 &#39;GUPscA_NIR_SpeX_Naud2014&#39;,
 &#39;2MASSJ0339-2434_NIR_SpeX_Gagne2015c&#39;]
</pre></div></div>
</div>
<p>Checking in the <a class="reference external" href="https://docs.google.com/spreadsheets/d/1136rRdcjHZJoe00mt4kPeWU8ZNORcPe-w4cipkDKGRc/edit#gid=0">online table of the MSL</a>, these spectra turn out to correspond to the following types of objects:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[135]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">labels_tmp</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;young M5.5&quot;</span><span class="p">,</span> <span class="s2">&quot;young M3&quot;</span><span class="p">,</span> <span class="s2">&quot;young M5&quot;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<p>Let’s finally plot the best-fit template spectra, at native resolution and resampled, respectively:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[136]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">special.model_resampling</span> <span class="kn">import</span> <span class="n">resample_model</span>

<span class="c1"># Prepare plot</span>
<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$\lambda F_{\lambda}$ (W m$^{-2}$)&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">lbda</span><span class="o">*</span><span class="p">(</span><span class="n">spec</span><span class="o">+</span><span class="n">spec_err</span><span class="p">)),</span>
             <span class="mf">1.1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">lbda</span><span class="o">*</span><span class="p">(</span><span class="n">spec</span><span class="o">+</span><span class="n">spec_err</span><span class="p">)))</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Wavelength ($\mu$m)&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;$\lambda F_{\lambda}$ (W m$^{-2}$)&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">lbda</span><span class="o">*</span><span class="p">(</span><span class="n">spec</span><span class="o">+</span><span class="n">spec_err</span><span class="p">)),</span>
             <span class="mf">1.1</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">lbda</span><span class="o">*</span><span class="p">(</span><span class="n">spec</span><span class="o">+</span><span class="n">spec_err</span><span class="p">)))</span>

<span class="c1"># plot options</span>
<span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">]</span> <span class="c1"># colors of different models</span>
<span class="n">maj_tick_sp</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># WL spacing for major ticks</span>
<span class="n">min_tick_sp</span> <span class="o">=</span> <span class="n">maj_tick_sp</span> <span class="o">/</span> <span class="mf">5.</span> <span class="c1"># WL spacing for minor ticks</span>

<span class="c1"># Plot of top 3 spectra:</span>
<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">object_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">ll</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_best</span><span class="p">):</span>
    <span class="c1">## loading</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="n">open_fits</span><span class="p">(</span><span class="n">inpath_models</span><span class="o">+</span><span class="n">final_tmpname</span><span class="p">[</span><span class="n">ll</span><span class="p">],</span><span class="n">header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">object_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;OBJECT&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">object_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">short_tmpname</span><span class="p">[</span><span class="n">ll</span><span class="p">])</span>
    <span class="n">lbda_tmp</span><span class="p">,</span> <span class="n">flux_tmp</span><span class="p">,</span> <span class="n">flux_tmp_err</span> <span class="o">=</span> <span class="n">final_tmp</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span>

    <span class="c1">## cropping range</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">idx_ini</span> <span class="o">=</span> <span class="n">find_nearest</span><span class="p">(</span><span class="n">lbda_tmp</span><span class="p">,</span><span class="mf">0.98</span><span class="o">*</span><span class="n">lbda_crop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">constraint</span><span class="o">=</span><span class="s1">&#39;floor&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">idx_ini</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">idx_fin</span> <span class="o">=</span> <span class="n">find_nearest</span><span class="p">(</span><span class="n">lbda_tmp</span><span class="p">,</span><span class="mf">1.02</span><span class="o">*</span><span class="n">lbda_crop</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">constraint</span><span class="o">=</span><span class="s1">&#39;ceil&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">idx_fin</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">lbda_tmp_crop</span> <span class="o">=</span> <span class="n">lbda_tmp</span><span class="p">[</span><span class="n">idx_ini</span><span class="p">:</span><span class="n">idx_fin</span><span class="p">]</span>
    <span class="n">flux_tmp_crop</span> <span class="o">=</span> <span class="n">flux_tmp</span><span class="p">[</span><span class="n">idx_ini</span><span class="p">:</span><span class="n">idx_fin</span><span class="p">]</span>
    <span class="n">dlbda_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lbda_tmp_crop</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">-</span><span class="n">lbda_tmp_crop</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1">## Convolving + resampling template spectrum</span>
    <span class="c1">### only consider non-zero and non-nan values</span>
    <span class="n">cond1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">flux_tmp</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cond2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">flux_tmp_err</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cond3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">flux_tmp</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">all_conds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">cond1</span><span class="p">,</span><span class="n">cond2</span><span class="p">,</span><span class="n">cond3</span><span class="p">))))</span>
    <span class="n">ngood_ch</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_conds</span><span class="p">)</span>
    <span class="n">good_ch</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_conds</span><span class="p">,)</span>
    <span class="n">lbda_tmp</span> <span class="o">=</span> <span class="n">lbda_tmp</span><span class="p">[</span><span class="n">good_ch</span><span class="p">]</span>
    <span class="n">flux_tmp</span> <span class="o">=</span> <span class="n">flux_tmp</span><span class="p">[</span><span class="n">good_ch</span><span class="p">]</span>
    <span class="n">flux_tmp_err</span> <span class="o">=</span> <span class="n">flux_tmp_err</span><span class="p">[</span><span class="n">good_ch</span><span class="p">]</span>
    <span class="n">tmp_res</span> <span class="o">=</span> <span class="n">resample_model</span><span class="p">(</span><span class="n">lbda_crop</span><span class="p">,</span> <span class="n">lbda_tmp</span><span class="p">,</span> <span class="n">flux_tmp</span><span class="p">,</span>
                             <span class="n">dlbda_obs</span><span class="o">=</span><span class="n">dlbda_crop</span><span class="p">,</span>
                             <span class="n">instru_fwhm</span><span class="o">=</span><span class="n">instru_fwhm_crop</span><span class="p">,</span>
                             <span class="n">instru_idx</span><span class="o">=</span><span class="n">instru_idx_crop</span><span class="p">,</span>
                             <span class="n">filter_reader</span><span class="o">=</span><span class="n">filter_reader</span><span class="p">)</span>
    <span class="n">lbda_tmp_res</span><span class="p">,</span> <span class="n">flux_tmp_res</span> <span class="o">=</span> <span class="n">tmp_res</span>

    <span class="c1">## formatting labels</span>
    <span class="n">lab_str_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">labels_tmp</span><span class="p">[</span><span class="n">ll</span><span class="p">]]</span>
    <span class="k">if</span> <span class="n">AV_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lab_str</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\Delta A_V$={0:.</span><span class="si">{1}</span><span class="s1">f}</span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">final_params</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ll</span><span class="p">],</span><span class="n">ndig</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">units</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">lab_str_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lab_str</span><span class="p">)</span>
    <span class="n">sep</span> <span class="o">=</span> <span class="s1">&#39;; &#39;</span>
    <span class="k">if</span> <span class="n">n_best</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Template #</span><span class="si">{:.0f}</span><span class="s2">: </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ll</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">short_tmpname</span><span class="p">[</span><span class="n">ll</span><span class="p">],</span> <span class="c1">#labels_tmp[ll],</span>
                                                   <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lab_str_list</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Best template: </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">short_tmpname</span><span class="p">[</span><span class="n">ll</span><span class="p">],</span> <span class="c1">#labels_tmp[ll],</span>
                                                <span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lab_str_list</span><span class="p">))</span>

    <span class="c1">## plotting</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lbda_tmp_crop</span><span class="p">,</span> <span class="n">lbda_tmp_crop</span><span class="o">*</span><span class="n">flux_tmp_crop</span><span class="p">,</span> <span class="n">cols</span><span class="p">[</span><span class="n">ll</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
             <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lbda_tmp_res</span><span class="p">,</span> <span class="n">lbda_tmp_res</span><span class="o">*</span><span class="n">flux_tmp_res</span><span class="p">,</span> <span class="n">cols</span><span class="p">[</span><span class="n">ll</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
             <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>

    <span class="c1">## ticks</span>
    <span class="n">min_tick</span> <span class="o">=</span> <span class="n">lbda_crop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dlbda_crop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="p">((</span><span class="n">lbda_crop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">dlbda_crop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">%</span><span class="k">0</span>.2)
    <span class="n">max_tick</span> <span class="o">=</span> <span class="n">lbda_crop</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dlbda_crop</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="mf">0.2</span><span class="o">-</span><span class="p">((</span><span class="n">lbda_crop</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">dlbda_crop</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">%</span><span class="k">0</span>.2))
    <span class="n">major_ticks1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_tick</span><span class="p">,</span><span class="n">max_tick</span><span class="p">,</span><span class="n">maj_tick_sp</span><span class="p">)</span>
    <span class="n">minor_ticks1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_tick</span><span class="p">,</span><span class="n">max_tick</span><span class="p">,</span><span class="n">min_tick_sp</span><span class="p">)</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">major_ticks1</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">minor_ticks1</span><span class="p">,</span> <span class="n">minor</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span> <span class="o">=</span> <span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;in&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">major_ticks1</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">minor_ticks1</span><span class="p">,</span> <span class="n">minor</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span> <span class="o">=</span> <span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">direction</span> <span class="o">=</span> <span class="s1">&#39;in&#39;</span><span class="p">)</span>

<span class="c1"># Plot measured spectrum</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">lbda_crop</span><span class="p">,</span> <span class="n">lbda_crop</span><span class="o">*</span><span class="n">spec_crop</span><span class="p">,</span>
             <span class="n">lbda_crop</span><span class="o">*</span><span class="n">spec_err_crop</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Measured spectrum&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">lbda_crop</span><span class="p">,</span> <span class="n">lbda_crop</span><span class="o">*</span><span class="n">spec_crop</span><span class="p">,</span>
             <span class="n">lbda_crop</span><span class="o">*</span><span class="n">spec_err_crop</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Measured spectrum&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Fits HDU-0 data and header successfully loaded. Data shape: (3, 4110)
Fits HDU-0 data and header successfully loaded. Data shape: (3, 4166)
Fits HDU-0 data and header successfully loaded. Data shape: (3, 4169)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_walkthrough_315_1.png" src="../_images/tutorials_walkthrough_315_1.png" />
</div>
</div>
<p><a class="reference external" href="#Table-of-contents">Go to the top</a></p>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../trimmed_readme.html" class="btn btn-neutral float-left" title="TL;DR setup guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../about.html" class="btn btn-neutral float-right" title="Contributions" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2022, Valentin Christiaens.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>